<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Chaotic Story: The Hectic Day Sim</title>
    <style>
        /* ===========================================
            RESET & BASE STYLES
            =========================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); /* Default / Morning */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #2d3748;
            line-height: 1.6;
            transition: background 2s ease-in-out; /* Smooth transition for day-night cycle */
        }

        /* NEW: Day-Night Cycle Backgrounds */
        body.day-morning {
            background: linear-gradient(135deg, #87CEEB 0%, #ADD8E6 100%); /* Light Blue Sky */
        }
        body.day-afternoon {
            background: linear-gradient(135deg, #6495ED 0%, #87CEEB 100%); /* Deeper Blue Sky */
        }
        body.day-evening {
            background: linear-gradient(135deg, #FF7F50 0%, #FFD700 100%); /* Sunset Orange to Gold */
        }
        body.day-night {
            background: linear-gradient(135deg, #1A202C 0%, #2D3748 100%); /* Dark Blue-Grey Night */
        }


        .game-container {
            width: 100%;
            max-width: 420px;
            min-height: 100vh;
            background: #ffffff;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            position: relative;
        }

        /* ===========================================
            SCREEN MANAGEMENT
            =========================================== */
        .screen {
            display: none;
            padding: 24px;
            min-height: 100vh;
            overflow-y: auto;
            animation: fadeIn 0.3s ease-in-out;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===========================================
            TYPOGRAPHY & COMMON ELEMENTS
            =========================================== */
        .title {
            font-size: 2.2em;
            font-weight: 700;
            text-align: center;
            margin-bottom: 16px;
            color: #2d3748;
        }

        .subtitle {
            font-size: 1.1em;
            text-align: center;
            margin-bottom: 32px;
            color: #4a5568;
            line-height: 1.5;
        }

        .game-logo {
            font-size: 4em;
            text-align: center;
            margin-bottom: 24px;
            line-height: 1;
        }

        /* ===========================================
            BUTTONS
            =========================================== */
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 8px 0;
            width: 100%;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.secondary {
            background: linear-gradient(45deg, #e2e8f0, #cbd5e0);
            color: #4a5568;
            box-shadow: 0 4px 15px rgba(203, 213, 224, 0.4);
        }

        .btn.secondary:hover {
            box-shadow: 0 6px 20px rgba(203, 213, 224, 0.6);
        }

        .btn.task-btn {
            background: linear-gradient(45deg, #48bb78, #38a169);
            font-size: 0.95em;
            padding: 14px 20px;
            margin: 6px 0;
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.4);
        }

        .btn.task-btn:hover {
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.6);
        }

        .btn.task-btn:disabled {
            background: #e2e8f0;
            color: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn.choice-btn {
            background: linear-gradient(45deg, #ed8936, #dd6b20);
            font-size: 0.9em;
            padding: 12px 16px;
            box-shadow: 0 4px 15px rgba(237, 137, 54, 0.4);
        }

        .btn.choice-btn:hover {
            box-shadow: 0 6px 20px rgba(237, 137, 54, 0.6);
        }

        /* ===========================================
            FORM ELEMENTS
            =========================================== */
        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
            font-size: 1.1em;
        }

        .form-group input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1em;
            background: white;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* NEW: Character Selection Grid */
        .character-selection-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Two columns */
            gap: 16px;
            margin-bottom: 24px;
        }

        .character-card {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 120px; /* Ensure cards have some height */
        }

        .character-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .character-card.selected {
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.3);
            background: linear-gradient(45deg, #e0e7ff, #c3dafe); /* Light blue gradient */
        }

        .character-card .emoji {
            font-size: 2.5em;
            margin-bottom: 10px;
            line-height: 1;
        }

        .character-card .label {
            font-weight: 600;
            color: #2d3748;
            font-size: 1em;
        }

        /* NEW: Pet Selection Grid */
        .pet-selection-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr; /* Three columns for no, dog, cat */
            gap: 16px;
            margin-bottom: 24px;
        }

        /* ===========================================
            DASHBOARD ELEMENTS
            =========================================== */
        .clock {
            background: linear-gradient(45deg, #fd746c, #ff6b6b);
            color: white;
            padding: 18px;
            border-radius: 16px;
            text-align: center;
            margin-bottom: 24px;
            font-size: 1.4em;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(253, 116, 108, 0.4);
        }

        .resources {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .resource {
            background: #f7fafc;
            padding: 18px;
            border-radius: 16px;
            text-align: center;
            border: 2px solid #e2e8f0;
            transition: transform 0.2s ease;
        }

        .resource:hover {
            transform: translateY(-2px);
        }

        .resource-icon {
            font-size: 2em;
            margin-bottom: 8px;
            display: block;
        }

        .resource-label {
            font-size: 0.9em;
            color: #4a5568;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .resource-value {
            font-size: 1.3em;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .resource-bar {
            background: #e2e8f0;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .resource-bar-fill {
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 4px;
        }

        .energy-bar {
            background: linear-gradient(45deg, #48bb78, #38a169);
        }
        /* NEW: Low Energy Warning */
        .resource.low-energy .energy-bar {
            background: linear-gradient(45deg, #f56565, #e53e3e); /* Red gradient */
            animation: pulseRed 1s infinite alternate;
        }
        @keyframes pulseRed {
            from { box-shadow: 0 0 0 0 rgba(229, 62, 62, 0.7); }
            to { box-shadow: 0 0 0 8px rgba(229, 62, 62, 0); }
        }


        .stress-bar {
            background: linear-gradient(45deg, #fc8181, #f56565);
        }

        .happiness-bar {
            background: linear-gradient(45deg, #fbb6ce, #f687b3);
        }

        .subscribers-bar {
            background: linear-gradient(45deg, #a78bfa, #8b5cf6);
        }
        
        /* NEW: Mood Display */
        .mood-display {
            background: linear-gradient(45deg, #a0aec0, #cbd5e0);
            color: #2d3748;
            padding: 12px 18px;
            border-radius: 16px;
            text-align: center;
            margin-bottom: 24px;
            font-size: 1.1em;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }


        /* ===========================================
            TASK SYSTEM
            =========================================== */
        .todo-section {
            margin-bottom: 24px;
        }

        .todo-title {
            font-size: 1.4em;
            font-weight: 700;
            margin-bottom: 16px;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .todo-list, .whims-list {
            /* Common styling for task lists */
        }

        .todo-item {
            background: #f7fafc;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .todo-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .todo-item:active {
            transform: scale(0.98);
        }

        /* Task category colors */
        .todo-item.work-task {
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
            border-color: #fc8181;
        }

        .todo-item.family-task {
            background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
            border-color: #68d391;
        }

        .todo-item.self-care-task {
            background: linear-gradient(135deg, #ebf8ff 0%, #bee3f8 100%);
            border-color: #63b3ed;
        }

        .todo-item.chore-task {
            background: linear-gradient(135deg, #faf5ff 0%, #e9d8fd 100%);
            border-color: #b794f6;
        }

        .todo-item.social-task {
            background: linear-gradient(135deg, #fffbf0 0%, #feebc8 100%);
            border-color: #f6ad55;
        }
        /* NEW: Whim task styling */
        .todo-item.whim-task {
            background: linear-gradient(135deg, #fefcbf 0%, #faf089 100%);
            border-color: #ecc94b;
        }


        .todo-item.completed {
            opacity: 0.6;
            transform: scale(0.98);
            text-decoration: line-through;
        }

        /* NEW: Style for disabled (sabotaged) tasks */
        .todo-item.sabotaged {
            background: #fed7d7;
            /* Light red background */
            border-color: #fc8181;
            /* Red border */
            opacity: 0.8;
            cursor: not-allowed;
            pointer-events: none;
            /* Disable clicks */
        }

        /* NEW: Style for internet-disabled tasks */
        .todo-item.internet-disabled {
            background: #e2e8f0; /* Grey background */
            border-color: #a0aec0; /* Grey border */
            opacity: 0.7;
            cursor: not-allowed;
            pointer-events: none;
        }
        .todo-item.internet-disabled .todo-text::after {
            content: " (No Internet)";
            font-size: 0.8em;
            color: #718096;
            margin-left: 5px;
        }


        .todo-text {
            font-size: 1.1em;
            margin-bottom: 12px;
            color: #2d3748;
            font-weight: 500;
        }

        .todo-details {
            font-size: 0.9em;
            color: #4a5568;
            margin-bottom: 12px;
        }

        /* ===========================================
            FEEDBACK SYSTEM
            =========================================== */
        .feedback {
            background: linear-gradient(45deg, #bee3f8, #90cdf4);
            color: #2b6cb0;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            text-align: center;
            border: 2px solid #90cdf4;
            font-weight: 600;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* NEW: Notification for Inner Demon */
        .demon-notification {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, #f56565, #e53e3e);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            text-align: center;
            box-shadow: 0 4px 15px rgba(229, 62, 62, 0.4);
            z-index: 1001;
            opacity: 0;
            animation: fadeInOut 3s forwards;
            /* Animation to fade in and out */
        }

        @keyframes fadeInOut {
            0% {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }

            10% {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }

            90% {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }

            100% {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
        }


        /* ===========================================
            MODAL SYSTEM (Now "Emergency Meeting")
            =========================================== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 32px;
            border-radius: 20px;
            max-width: 380px;
            width: 90%;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            animation: scaleIn 0.3s ease;
            /* NEW: For scrollable content in modals */
            max-height: 80vh; /* Limit height to 80% of viewport height */
            display: flex; /* Use flexbox to push button to bottom */
            flex-direction: column; /* Stack content vertically */
        }

        /* NEW: Scrollable content area within modal */
        .modal-scroll-content {
            flex-grow: 1; /* Allows this area to take available space */
            overflow-y: auto; /* Enable vertical scrolling */
            padding-bottom: 20px; /* Space above the button */
        }


        @keyframes scaleIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal-title {
            font-size: 1.6em;
            font-weight: 700;
            margin-bottom: 16px;
            color: #2d3748;
        }

        .modal-text {
            margin-bottom: 24px;
            color: #4a5568;
            line-height: 1.5;
            font-size: 1.1em;
            white-space: pre-wrap; /* Preserve whitespace and line breaks for instructions */
            text-align: left; /* Align text left for readability */
        }

        .modal-choices {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: auto; /* Pushes choices to the bottom of the flex container */
        }

        /* ===========================================
            END OF DAY SUMMARY (Now "My Chaotic Story Daily Report")
            =========================================== */
        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        /* NEW: Styles for the categorized report cells */
        .report-category {
            background: #f7fafc;
            padding: 18px;
            border-radius: 16px;
            text-align: center;
            border: 2px solid #e2e8f0;
            transition: transform 0.2s ease;
        }

        .report-category .icon {
            font-size: 2em;
            margin-bottom: 8px;
            display: block;
        }

        .report-category .label {
            font-size: 0.9em;
            color: #4a5568;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .report-category .status {
            font-size: 1.3em;
            font-weight: 700;
            color: #2d3748;
        }

        /* Status colors */
        .status-balanced {
            color: #48bb78;
        }

        /* Green */
        .status-strained {
            color: #ed8936;
        }

        /* Orange */
        .status-critical {
            color: #fc8181;
        }

        /* Red */


        .summary-message {
            background: linear-gradient(45deg, #f0fff4, #c6f6d5);
            color: #22543d;
            padding: 24px;
            border-radius: 16px;
            text-align: center;
            margin-bottom: 24px;
            border: 2px solid #9ae6b4;
            font-size: 1.2em;
            font-weight: 600;
            line-height: 1.4;
        }

        /* ===========================================
            TASK ANIMATIONS
            =========================================== */
        .animation-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }

        .animation-container.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .animation-container.active .animation-scene {
            animation: popInWithPulse 0.5s ease;
        }

        .animation-scene {
            background: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 350px;
            width: 90%;
            max-height: 80vh;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
            margin: auto;
        }

        .animation-title {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 20px;
            color: #2d3748;
        }

        .animation-visual {
            font-size: 4em;
            margin: 20px 0;
            line-height: 1;
            animation: taskBounce 1.5s ease-in-out infinite;
        }

        .animation-description {
            font-size: 1.1em;
            color: #4a5568;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        /* Specific animations for different task types */
        .morning-routine-anim {
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
        }

        .morning-routine-anim .animation-visual {
            animation: morningStretch 2s ease-in-out infinite;
        }

        .feed-kids-anim {
            background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
        }

        .feed-kids-anim .animation-visual {
            animation: feedingMotion 1.8s ease-in-out infinite;
        }

        .work-anim {
            background: linear-gradient(135deg, #ebf8ff 0%, #bee3f8 100%);
        }

        .work-anim .animation-visual {
            animation: workTyping 1.2s ease-in-out infinite;
        }

        .play-anim {
            background: linear-gradient(135deg, #faf5ff 0%, #e9d8fd 100%);
        }

        .play-anim .animation-visual {
            animation: playBounce 1s ease-in-out infinite;
        }

        .nap-anim {
            background: linear-gradient(135deg, #fffbf0 0%, #feebc8 100%);
        }

        .nap-anim .animation-visual {
            animation: sleepSway 3s ease-in-out infinite;
        }

        .study-anim {
            background: linear-gradient(135deg, #e0f2f7 0%, #b2e2f2 100%);
        }

        .study-sim .animation-visual {
            animation: studyThink 2s ease-in-out infinite;
        }

        .grocery-anim {
            background: linear-gradient(135deg, #f3e5f5 0%, #d8b6e0 100%);
        }

        .grocery-anim .animation-visual {
            animation: groceryPush 1.5s ease-in-out infinite;
        }

        .chores-anim {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
        }

        .chores-anim .animation-visual {
            animation: choreSwish 1.8s ease-in-out infinite;
        }

        .social-media-anim {
            background: linear-gradient(135deg, #fffde7 0%, #fff9c4 100%);
        }

        .social-media-anim .animation-visual {
            animation: socialScroll 2s ease-in-out infinite;
        }

        /* New animations for specific jobs */
        .international-student-anim {
            background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);
        }
        .international-student-anim .animation-visual {
            animation: studentLearn 2s ease-in-out infinite;
        }
        @keyframes studentLearn {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05) translateY(-5px); }
        }

        .youtuber-anim {
            background: linear-gradient(135deg, #ffe0b2 0%, #ffcc80 100%);
        }
        .youtuber-anim .animation-visual {
            animation: youtuberCreate 1.5s ease-in-out infinite;
        }
        @keyframes youtuberCreate {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(5deg) scale(1.05); }
        }

        .nurse-anim { /* NEW: Nurse animation */
            background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 100%); /* Light pink/purple */
        }
        .nurse-anim .animation-visual {
            animation: nurseCare 1.8s ease-in-out infinite;
        }
        @keyframes nurseCare {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-5px) rotate(3deg); }
        }

        /* NEW: Stress Breakdown Animation */
        .stress-breakdown-anim {
            background: linear-gradient(135deg, #fbcfe8 0%, #f472b6 100%); /* Pink/Red gradient */
        }
        .stress-breakdown-anim .animation-visual {
            animation: weepPulse 1.2s ease-in-out infinite;
            color: #e11d48; /* Darker red for emphasis */
        }
        @keyframes weepPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1) translateY(-5px); opacity: 0.8; }
        }

        /* NEW: Pet animations */
        .pet-care-anim {
            background: linear-gradient(135deg, #d2f7d2 0%, #a8e6a8 100%);
        }
        .pet-care-anim .animation-visual {
            animation: petWiggle 1.5s ease-in-out infinite;
        }
        @keyframes petWiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(5deg); }
            75% { transform: rotate(-5deg); }
        }
        .pet-chaos-anim {
            background: linear-gradient(135deg, #ffdddd 0%, #ffaaaa 100%);
        }
        .pet-chaos-anim .animation-visual {
            animation: chaosShake 0.5s infinite alternate;
            color: #cc0000;
        }
        @keyframes chaosShake {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            25% { transform: translateX(-5px) rotate(-3deg); }
            75% { transform: translateX(5px) rotate(3deg); }
        }


        /* Animation keyframes */
        @keyframes taskBounce {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-10px) scale(1.1); }
        }

        @keyframes morningStretch {
            0%, 100% { transform: rotate(-5deg) scale(1); }
            33% { transform: rotate(0deg) scale(1.1); }
            66% { transform: rotate(5deg) scale(1.05); }
        }

        @keyframes feedingMotion {
            0%, 100% { transform: translateX(0) scale(1); }
            25% { transform: translateX(-5px) scale(1.05); }
            75% { transform: translateX(5px) scale(1.05); }
        }

        @keyframes workTyping {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes playBounce {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-15px) rotate(10deg); }
        }

        @keyframes sleepSway {
            0%, 100% { transform: rotate(-2deg); }
            50% { transform: rotate(2deg); }
        }

        @keyframes studyThink {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05) rotateY(10deg); }
        }

        @keyframes groceryPush {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(5px); }
        }

        @keyframes choreSwish {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(5deg); }
        }

        @keyframes socialScroll {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }


        @keyframes popInWithPulse {
            0% { 
                transform: scale(0.3);
                opacity: 0;
            }
            70% { 
                transform: scale(1.05);
                opacity: 1;
            }
            100% { 
                transform: scale(1);
                opacity: 1;
            }
        }

        .close-animation-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px; /* Space from content */
        }

        .close-animation-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        /* ===========================================
            RESPONSIVE DESIGN
            =========================================== */
        @media (max-width: 480px) {
            .game-container {
                border-radius: 0;
                max-width: 100%;
            }

            .screen {
                padding: 16px;
            }

            .title {
                font-size: 1.8em;
            }

            .game-logo {
                font-size: 3em;
            }

            .resources {
                grid-template-columns: 1fr;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 360px) {
            .btn {
                padding: 14px 20px;
                font-size: 1em;
            }

            .resource {
                padding: 14px;
            }
        }
    </style>
</head>

<body>
    <div class="game-container">
        <!-- ===============================================
              START SCREEN
              =============================================== -->
        <div id="start-screen" class="screen active">
            <div class="game-logo">üè†üíºüë∂</div>
            <h1 class="title">My Chaotic Story</h1>
            <p class="subtitle">The Hectic Day Sim<br><em>Navigate the beautiful chaos of modern life</em></p>
            <button class="btn" onclick="showCharacterCreationScreen()">
                üéÆ Start New Game
            </button>
            <button class="btn secondary" onclick="showHowToPlay()">
                ‚ùì How to Play
            </button>
        </div>

        <!-- ===============================================
              CHARACTER CREATION SCREEN
              =============================================== -->
        <div id="character-creation-screen" class="screen">
            <h1 class="title">Create Your Life</h1>
            <p class="subtitle">Set up your character and family situation</p>

            <div class="form-group">
                <label for="player-name">üë§ Name your character:</label>
                <input type="text" id="player-name" placeholder="Name your character" maxlength="20">
            </div>

            <div class="form-group">
                <label>üíº Choose Your Job:</label>
                <div class="character-selection-grid" id="job-selection-grid">
                    <div class="character-card" data-job="shop-assistant" onclick="selectJob('shop-assistant')">
                        <span class="emoji">üè™</span>
                        <span class="label">Shop Assistant</span>
                    </div>
                    <div class="character-card" data-job="international-student" onclick="selectJob('international-student')">
                        <span class="emoji">üéì</span>
                        <span class="label">International Student</span>
                    </div>
                    <div class="character-card" data-job="youtuber" onclick="selectJob('youtuber')">
                        <span class="emoji">üéÆ</span>
                        <span class="label">YouTuber Gamer</span>
                    </div>
                    <div class="character-card" data-job="nurse" onclick="selectJob('nurse')">
                        <span class="emoji">ü©∫</span>
                        <span class="label">Nurse</span>
                    </div>
                </div>
            </div>

            <div class="form-group" id="num-kids-group">
                <label>üë∂ Number of Kids:</label>
                <div class="character-selection-grid" id="kids-selection-grid">
                    <div class="character-card" data-kids="0" onclick="selectKids(0)">
                        <span class="emoji">üö´</span>
                        <span class="label">0 Kids</span>
                    </div>
                    <div class="character-card" data-kids="1" onclick="selectKids(1)">
                        <span class="emoji">üë∂</span>
                        <span class="label">1 Kid</span>
                    </div>
                    <div class="character-card" data-kids="2" onclick="selectKids(2)">
                        <span class="emoji">üçºüë∂</span>
                        <span class="label">2 Kids</span>
                    </div>
                </div>
            </div>

            <!-- NEW: Pet Selection -->
            <div class="form-group">
                <label>üêæ Pet Type:</label>
                <div class="pet-selection-grid" id="pet-selection-grid">
                    <div class="character-card" data-pet="none" onclick="selectPet('none')">
                        <span class="emoji">üö´</span>
                        <span class="label">No Pet</span>
                    </div>
                    <div class="character-card" data-pet="dog" onclick="selectPet('dog')">
                        <span class="emoji">üê∂</span>
                        <span class="label">Dog</span>
                    </div>
                    <div class="character-card" data-pet="cat" onclick="selectPet('cat')">
                        <span class="emoji">üê±</span>
                        <span class="label">Cat</span>
                    </div>
                </div>
            </div>

            <button class="btn" onclick="startNewGame()">
                ‚ú® Confirm & Start Day
            </button>
        </div>

        <!-- ===============================================
              DAILY DASHBOARD
              =============================================== -->
        <div id="daily-dashboard" class="screen">
            <div class="clock" id="game-clock">Day 1: 07:00 AM</div>

            <!-- NEW: Mood Display -->
            <div class="mood-display" id="mood-display">Mood: Neutral üòê</div>

            <!-- NEW: Daily Dilemma Display -->
            <div id="daily-dilemma-display" class="feedback" style="display: none;"></div>

            <div class="resources">
                <div class="resource" id="energy-resource-container">
                    <span class="resource-icon">üîã</span>
                    <div class="resource-label">Energy</div>
                    <div class="resource-value" id="energy-value">100%</div>
                    <div class="resource-bar">
                        <div class="resource-bar-fill energy-bar" id="energy-bar" style="width: 100%"></div>
                    </div>
                </div>

                <div class="resource">
                    <span class="resource-icon">üí∞</span>
                    <div class="resource-label">Money</div>
                    <div class="resource-value" id="money-value">$500</div>
                </div>

                <div class="resource">
                    <span class="resource-icon">ü§Ø</span>
                    <div class="resource-label">Stress</div>
                    <div class="resource-value" id="stress-value">0%</div>
                    <div class="resource-bar">
                        <div class="resource-bar-fill stress-bar" id="stress-bar" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Dynamically change based on job -->
                <div class="resource" id="dynamic-resource">
                    <span class="resource-icon" id="dynamic-resource-icon">üòä</span>
                    <div class="resource-label" id="dynamic-resource-label">Kid Happiness</div>
                    <div class="resource-value" id="dynamic-resource-value">80%</div>
                    <div class="resource-bar">
                        <div class="resource-bar-fill happiness-bar" id="dynamic-resource-bar" style="width: 80%"></div>
                    </div>
                </div>

                <!-- NEW: Social Life Resource -->
                <div class="resource" id="social-resource">
                    <span class="resource-icon">ü§ù</span>
                    <div class="resource-label">Social Life</div>
                    <div class="resource-value" id="social-value">70%</div>
                    <div class="resource-bar">
                        <div class="resource-bar-fill happiness-bar" id="social-bar" style="width: 70%"></div>
                    </div>
                </div>

                <!-- NEW: Pet Happiness Resource -->
                <div class="resource" id="pet-resource" style="display: none;">
                    <span class="resource-icon" id="pet-icon">üêæ</span>
                    <div class="resource-label">Pet Happiness</div>
                    <div class="resource-value" id="pet-happiness-value">100%</div>
                    <div class="resource-bar">
                        <div class="resource-bar-fill happiness-bar" id="pet-happiness-bar" style="width: 100%"></div>
                    </div>
                </div>
            </div>

            <div id="feedback-area"></div>

            <!-- NEW: Animation container for task visuals -->
            <div id="task-animation-container" class="animation-container">
                <div id="task-animation-scene" class="animation-scene"></div>
            </div>

            <div class="todo-section">
                <h2 class="todo-title">üìù Today's Tasks</h2>
                <div id="todo-list">
                    <!-- Tasks will be populated by JavaScript -->
                </div>
            </div>

            <!-- NEW: Whims Section -->
            <div class="todo-section" id="whims-section" style="display: none;">
                <h2 class="todo-title">‚ú® Whims & Opportunities</h2>
                <div id="whims-list">
                    <!-- Whims will be populated by JavaScript -->
                </div>
            </div>

            <!-- Removed the test random event button, as Lord Procrastinatus will trigger randomly -->
            <!-- <button class="btn secondary" onclick="triggerRandomEvent()">
                üé≤ Random Event (Test)
            </button> -->
        </div>

        <!-- ===============================================
              END OF DAY SUMMARY (Now "My Chaotic Story Daily Report")
              =============================================== -->
        <div id="end-of-day-screen" class="screen">
            <h1 class="title">Day <span id="summary-day-number">1</span> Summary</h1>
            <p class="subtitle">How did you navigate today's challenges?</p>

            <!-- NEW: Life's Ledger Daily Report Grid -->
            <div class="summary-grid" id="daily-report-grid">
                <!-- Report categories will be populated by JavaScript -->
            </div>

            <div class="summary-message" id="day-summary">
                You made it through another day! üåü
            </div>

            <button class="btn" onclick="nextDay()">
                üåÖ Next Day
            </button>
            <button class="btn secondary" onclick="checkPlayabilityAndLoadGame()">
                üè† Main Menu
            </button>
        </div>

        <!-- ===============================================
              RANDOM EVENT MODAL (Now "Emergency Meeting!")
              =============================================== -->
        <div id="random-event-modal" class="modal">
            <div class="modal-content">
                <div class="modal-scroll-content"> <!-- NEW: Scrollable content wrapper -->
                    <h2 class="modal-title" id="event-title">Emergency Meeting!</h2>
                    <p class="modal-text" id="event-description">Something unexpected happened!</p>
                </div>
                <div class="modal-choices" id="event-choices">
                    <!-- Choices will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- NEW: Inner Demon Notification -->
        <div id="demon-notification" class="demon-notification" style="display: none;"></div>

        <!-- NEW: Playability Check Modal -->
        <div id="playability-modal" class="modal">
            <div class="modal-content">
                <div class="modal-scroll-content"> <!-- NEW: Scrollable content wrapper -->
                    <h2 class="modal-title" id="playability-title"></h2>
                    <p class="modal-text" id="playability-message"></p>
                </div>
                <button class="btn" onclick="hideModal('playability-modal')">Okay</button>
            </div>
        </div>

        <!-- NEW: Energy Depleted Modal -->
        <div id="energy-depleted-modal" class="modal">
            <div class="modal-content">
                <h2 class="modal-title">üîã Energy Depleted!</h2>
                <p class="modal-text">You've run out of energy for the day. Time to rest!</p>
                <button class="btn" onclick="hideModal('energy-depleted-modal'); endDay();">End Day</button>
            </div>
        </div>

        <!-- NEW: Stress Depleted Modal (Added to fix the error) -->
        <div id="stress-depleted-modal" class="modal">
            <div class="modal-content">
                <h2 class="modal-title">ü§Ø Burnout!</h2>
                <p class="modal-text">Your stress levels are too high! You've reached burnout. Time to take a break!</p>
                <button class="btn" onclick="hideModal('stress-depleted-modal'); endDay();">End Day</button>
            </div>
        </div>

    </div>

    <script>
        // ===============================================
        // GAME STATE MANAGEMENT
        // ===============================================
        let gameState = {
            playerName: '',
            numKids: 0, // Default to 0, selected via UI
            job: '', // Selected via UI
            petType: 'none', // NEW: 'none', 'dog', 'cat'
            day: 1,
            time: 7, // 24-hour format (7 = 7:00 AM)
            energy: 100,
            money: 500,
            stress: 0,
            kidHappiness: 80, // Default for non-YouTuber
            subscribers: 0, // For YouTuber
            socialLife: 70, // NEW: Social life meter
            petHappiness: 100, // NEW: Pet happiness
            mood: 'Neutral', // NEW: Current mood
            milestoneAchieved: false, // Flag for subscriber milestone
            completedTasks: [],
            tasksCompletedToday: 0,
            procrastinatusActive: false,
            activeWhims: [], // NEW: Array to hold active mini-quests
            billsDue: [], // NEW: Array to hold upcoming bills
            missedDeadlines: [], // NEW: Array to track missed deadlines
            internetDown: false, // NEW: Flag for internet outage
            // NEW: Flags for bus consequences
            nextDayShiftPenalty: false,
            nextDayLectureConsequence: null, // 'lockedOut' or 'humiliated'
            isWorkingToday: false, // NEW: Flag to track if character is working/studying today
            isOffDay: false // NEW: Flag to indicate if it's a designated off-day
        };

        // NEW: Selected character properties for UI
        let selectedJob = null;
        let selectedKids = null;
        let selectedPet = null;

        const MIN_TASKS_PER_DAY = 12; // NEW: Minimum tasks per day
        const COOLDOWN_HOURS = 0.05; // Cooldown period in hours (3 minutes for testing)
        // const COOLDOWN_HOURS = 6; // Original 6 hours

        let cooldownIntervalId = null; // To store the interval ID for cooldown clock

        // ===============================================
        // TASKS DATABASE - Grouped by Job Role
        // ===============================================
        const commonTasks = [
            {
                id: 'morning-routine-common',
                text: 'üåÖ Morning Routine',
                details: 'Get yourself ready for the day',
                time: 1,
                effects: {energy: -10, stress: +5, mood: 'Neutral'},
                message: 'Morning routine complete! Ready for the day. üåÖ',
                animation: {emoji: '‚òï', class: 'morning-routine-anim', description: 'Waking up and getting ready...'},
                appliesTo: ['shop-assistant', 'international-student', 'nurse'] // Does not apply to YouTuber
            },
            {
                id: 'pay-rent',
                text: 'üè† Pay Rent',
                details: 'Monthly rent payment due today!',
                time: 0, // Instant
                effects: {money: -500, stress: -10},
                message: 'Rent paid! One less thing to worry about. üí∏',
                animation: {emoji: 'üè°', class: 'chore-anim', description: 'Keeping a roof over your head.'},
                deadlineDay: 5, // Example: Rent due on Day 5
                appliesTo: ['shop-assistant', 'international-student', 'youtuber', 'nurse']
            },
            {
                id: 'pay-utilities', // NEW: Utilities bill
                text: 'üí° Pay Utilities',
                details: 'Electricity and heating bill due today!',
                time: 0,
                effects: {money: -80, stress: -5},
                message: 'Utilities paid. Stay warm and lit! üí°',
                animation: {emoji: '‚ö°', class: 'chore-anim', description: 'Keeping the lights on.'},
                deadlineDay: 7,
                appliesTo: ['shop-assistant', 'international-student', 'youtuber', 'nurse']
            },
            {
                id: 'pay-internet', // NEW: Internet bill
                text: 'üåê Pay Internet Bill',
                details: 'Ensure your connection stays active!',
                time: 0,
                effects: {money: -60, stress: -5},
                message: 'Internet bill paid. Stay connected! üåê',
                animation: {emoji: 'üì°', class: 'chore-anim', description: 'Keeping the Wi-Fi flowing.'},
                deadlineDay: 3,
                appliesTo: ['shop-assistant', 'international-student', 'youtuber', 'nurse']
            },
            {
                id: 'nap-rest',
                text: 'üò¥ Power Nap',
                details: 'Quick 30-minute recharge',
                time: 1,
                effects: {energy: +25, stress: -15, mood: 'Happy'},
                message: 'Short nap helped you recharge! üò¥',
                animation: {emoji: 'üí§', class: 'nap-anim', description: 'Shhh... recharging batteries.'},
                appliesTo: ['shop-assistant', 'international-student', 'youtuber', 'nurse']
            },
            {
                id: 'house-chores',
                text: 'üßπ House Cleaning',
                details: 'Laundry, dishes, and tidying up',
                time: 2,
                effects: {energy: -20, stress: +5, mood: 'Neutral'},
                message: 'House is clean! A tidy space helps. üßπ',
                animation: {emoji: 'üßº', class: 'chores-anim', description: 'Scrub-a-dub-dub, the house is clean!'},
                appliesTo: ['shop-assistant', 'international-student', 'youtuber', 'nurse']
            },
            {
                id: 'call-friend',
                text: 'üìû Call a Friend',
                details: 'Catch up with a friend',
                time: 1,
                effects: {energy: -5, stress: -10, socialLife: +20, mood: 'Happy'},
                message: 'Good chat with a friend! Feeling more connected. ‚ù§Ô∏è',
                animation: {emoji: 'üí¨', class: 'social-media-anim', description: 'Connecting with loved ones.'},
                appliesTo: ['shop-assistant', 'international-student', 'youtuber', 'nurse']
            },
            {
                id: 'buy-lottery-ticket',
                text: 'üé´ Buy Lottery Ticket',
                details: 'Feeling lucky? Small chance for big money!',
                time: 0.5,
                effects: {money: -5, stress: +5}, // Initial stress/money cost
                message: 'Lottery ticket bought. Fingers crossed! ü§û',
                animation: {emoji: 'üçÄ', class: 'chore-anim', description: 'Hoping for a win.'},
                appliesTo: ['shop-assistant', 'international-student', 'youtuber', 'nurse']
            },
            {
                id: 'grocery-shopping',
                text: 'üõí Grocery Shopping',
                details: 'Weekly groceries - prices keep rising',
                time: 2,
                effects: {energy: -25, money: -65, stress: +20, mood: 'Stressed'},
                message: 'Groceries done! $65 spent - when did food get so expensive? üõí',
                animation: {emoji: 'üõçÔ∏è', class: 'grocery-anim', description: 'Navigating the aisles of inflation.'},
                appliesTo: ['shop-assistant', 'international-student', 'youtuber', 'nurse'],
                triggerTantrum: true // NEW: Flag to trigger tantrum event
            },
            // NEW: Offline Tasks for Internet Outage
            {
                id: 'read-book',
                text: 'üìñ Read a Book',
                details: 'Unplug and dive into a good story',
                time: 1.5,
                effects: {energy: +10, stress: -15, mood: 'Happy'},
                message: 'Lost yourself in a book. A peaceful escape. üìö',
                animation: {emoji: 'üìñ', class: 'study-anim', description: 'Enjoying some quiet time.'},
                requiresInternet: false,
                appliesTo: ['shop-assistant', 'international-student', 'youtuber', 'nurse']
            },
            {
                id: 'tidy-corner',
                text: 'üßπ Tidy Up a Messy Corner',
                details: 'Organize a small part of your home',
                time: 1,
                effects: {energy: -5, stress: -5, mood: 'Neutral'},
                message: 'One less mess to worry about! üßº',
                animation: {emoji: '‚ú®', class: 'chores-anim', description: 'Making your space sparkle.'},
                requiresInternet: false,
                appliesTo: ['shop-assistant', 'international-student', 'youtuber', 'nurse']
            },
            {
                id: 'stare-at-wall',
                text: 'üò∂ Stare at Wall',
                details: 'Sometimes you just need to exist',
                time: 1,
                effects: {energy: -5, stress: +10, mood: 'Bored'},
                message: 'You stared at the wall for a while. Not very productive. üòê',
                animation: {emoji: 'üëÅÔ∏è', class: 'nap-anim', description: 'Deep thoughts... or no thoughts.'},
                requiresInternet: false,
                appliesTo: ['shop-assistant', 'international-student', 'youtuber', 'nurse']
            },
            // NEW: User-suggested stress-reducing tasks
            {
                id: 'long-walk',
                text: 'üå≥ Long Walk in the Park',
                details: 'Enjoy nature, clear your head',
                time: 2,
                effects: {energy: -10, stress: -25, mood: 'Happy'},
                message: 'A refreshing walk. The fresh air did wonders for your stress! üçÉ',
                animation: {emoji: 'üö∂‚Äç‚ôÄÔ∏è', class: 'self-care-task', description: 'Strolling through nature.'},
                requiresInternet: false,
                appliesTo: ['shop-assistant', 'international-student', 'youtuber', 'nurse']
            },
            {
                id: 'journaling',
                text: '‚úçÔ∏è Journaling / Reflect',
                details: 'Write down your thoughts and feelings',
                time: 1,
                effects: {energy: -5, stress: -20, mood: 'Inspired'},
                message: 'Putting thoughts on paper brought clarity and calm. üìñ',
                animation: {emoji: 'üìù', class: 'self-care-task', description: 'Expressing inner thoughts.'},
                requiresInternet: false,
                appliesTo: ['shop-assistant', 'international-student', 'youtuber', 'nurse']
            },
            {
                id: 'yoga-session',
                text: 'üßò Yoga Session',
                details: 'Stretch and find your inner peace',
                time: 1.5,
                effects: {energy: -10, stress: -20, mood: 'Happy'},
                message: 'Feeling centered and relaxed after yoga. Namaste. üßò',
                animation: {emoji: 'üïâÔ∏è', class: 'self-care-task', description: 'Finding balance and peace.'},
                requiresInternet: false,
                appliesTo: ['shop-assistant', 'international-student', 'youtuber', 'nurse']
            },
            {
                id: 'creative-outlet',
                text: 'üé® Creative Outlet (Painting/Drawing)',
                details: 'Express yourself through art',
                time: 2,
                effects: {energy: -15, stress: -25, mood: 'Inspired'},
                message: 'Lost track of time creating art. A wonderful escape! üñåÔ∏è',
                animation: {emoji: 'üñºÔ∏è', class: 'self-care-task', description: 'Unleashing your inner artist.'},
                requiresInternet: false,
                appliesTo: ['shop-assistant', 'international-student', 'youtuber', 'nurse']
            },
            {
                id: 'dance-party',
                text: 'üíÉ Dance Party (Solo)',
                details: 'Put on some music and just dance!',
                time: 1,
                effects: {energy: -15, stress: -20, mood: 'Happy', socialLife: +5},
                message: 'Danced like no one was watching! Feeling energized and free. üé∂',
                animation: {emoji: 'üï∫', class: 'social-task', description: 'Grooving to your own beat.'},
                requiresInternet: true,
                appliesTo: ['shop-assistant', 'international-student', 'youtuber', 'nurse']
            }
        ];

        const jobSpecificTasks = {
            'shop-assistant': [
                {
                    id: 'daycare-dropoff',
                    text: 'üë∂ Daycare Drop-off',
                    details: 'Take the kids to daycare before work/class.',
                    time: 1,
                    effects: {energy: -10, stress: +10, money: -15, kidHappiness: +5, mood: 'Neutral'},
                    message: 'Kids dropped off at daycare. Now, to catch that bus...',
                    animation: {emoji: 'üöå', class: 'family-task', description: 'Rushing to drop off the little ones.'},
                    appliesTo: ['shop-assistant', 'international-student', 'nurse'],
                    requiresKids: true,
                    triggerBusEvent: true // NEW: Flag to trigger the bus event
                },
                {
                    id: 'daycare-pickup',
                    text: 'üçº Daycare Pick-up',
                    details: 'Pick up the kids from daycare after your day.',
                    time: 1,
                    effects: {energy: -10, stress: +5, kidHappiness: +10, mood: 'Happy'},
                    message: 'Kids picked up! They\'re tired but happy to see you.',
                    animation: {emoji: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', class: 'family-task', description: 'Reuniting with the family.'},
                    appliesTo: ['shop-assistant', 'international-student', 'nurse'],
                    requiresKids: true
                },
                {
                    id: 'feed-kids',
                    text: 'üçº Feed the Kids',
                    details: 'Breakfast time - nutritious meals cost more',
                    time: 1,
                    effects: {energy: -15, money: -8, kidHappiness: +20, stress: +10, mood: 'Neutral'},
                    message: 'Kids are fed and happy, but groceries are getting expensive! üçº',
                    animation: {emoji: 'ü•£', class: 'feed-kids-anim', description: 'Spoon-feeding tiny humans...'}
                },
                {
                    id: 'work-shift',
                    text: 'üíº Work Shift (Shop Assistant)',
                    details: 'Full 8-hour shift at the shop',
                    time: 8,
                    effects: {energy: -40, money: +96, stress: +25, mood: 'Stressed'},
                    message: 'Long day at work earned you $96, but you\'re exhausted! üíº',
                    animation: {emoji: 'üíª', class: 'work-anim', description: 'Typing, selling, smiling...'},
                    requiresInternet: false, // Assuming shop assistant work can be done offline
                    isWorkTask: true // NEW: Flag for work-related task
                },
                {
                    id: 'part-time-work',
                    text: 'üëî Part-Time Work (Shop Assistant)',
                    details: 'Shorter 4-hour shift for family balance',
                    time: 4,
                    effects: {energy: -20, money: +48, stress: +15, mood: 'Neutral'},
                    message: 'Half day at work - $48 earned, more time for family! üëî',
                    animation: {emoji: 'üõí', class: 'work-anim', description: 'Quick shift, still productive!'},
                    requiresInternet: false,
                    isWorkTask: true // NEW: Flag for work-related task
                },
                {
                    id: 'study-skill',
                    text: 'üìö Study New Skill',
                    details: 'Online course to improve career prospects',
                    time: 2,
                    effects: {energy: -20, stress: +10, money: -15, mood: 'Inspired'},
                    message: 'Learning new skills for the future! Course fee: $15 üìö',
                    animation: {emoji: 'üß†', class: 'study-anim', description: 'Brain cells activating...'},
                    requiresInternet: true
                },
                {
                    id: 'quality-time',
                    text: 'üéÆ Play with Kids',
                    details: 'Precious bonding time with your children',
                    time: 2,
                    effects: {energy: -15, kidHappiness: +30, stress: -10, mood: 'Happy'},
                    message: 'Amazing time with the kids! Their laughter is priceless. üéÆ',
                    animation: {emoji: 'üß∏', class: 'play-anim', description: 'Tickles, giggles, and endless energy!'},
                    requiresInternet: false
                },
                {
                    id: 'social-media',
                    text: 'üì± Social Media Break',
                    details: 'Quick scroll through social feeds',
                    time: 1,
                    effects: {energy: -5, stress: +15, mood: 'Bored'},
                    message: 'Scrolled through social media... everyone else seems to have it figured out. üì±',
                    animation: {emoji: 'ü§≥', class: 'social-media-anim', description: 'Just a quick peek... or two... or ten.'},
                    requiresInternet: true
                }
            ],
            'international-student': [
                {
                    id: 'daycare-dropoff',
                    text: 'üë∂ Daycare Drop-off',
                    details: 'Take the kids to daycare before work/class.',
                    time: 1,
                    effects: {energy: -10, stress: +10, money: -15, kidHappiness: +5, mood: 'Neutral'},
                    message: 'Kids dropped off at daycare. Now, to catch that bus...',
                    animation: {emoji: 'üöå', class: 'family-task', description: 'Rushing to drop off the little ones.'},
                    appliesTo: ['shop-assistant', 'international-student', 'nurse'],
                    requiresKids: true,
                    triggerBusEvent: true // NEW: Flag to trigger the bus event
                },
                {
                    id: 'daycare-pickup',
                    text: 'üçº Daycare Pick-up',
                    details: 'Pick up the kids from daycare after your day.',
                    time: 1,
                    effects: {energy: -10, stress: +5, kidHappiness: +10, mood: 'Happy'},
                    message: 'Kids picked up! They\'re tired but happy to see you.',
                    animation: {emoji: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', class: 'family-task', description: 'Reuniting with the family.'},
                    appliesTo: ['shop-assistant', 'international-student', 'nurse'],
                    requiresKids: true
                },
                {
                    id: 'attend-lectures',
                    text: 'üßë‚Äçüéì Attend Lectures (Western U)',
                    details: 'Keep up with your studies at Western University',
                    time: 3,
                    effects: {energy: -15, stress: +10, growth: +5, mood: 'Neutral'},
                    message: 'Another lecture down. Brain is full! üìö',
                    animation: {emoji: 'üßë‚Äçüéì', class: 'international-student-anim', description: 'Absorbing knowledge at Western...'},
                    requiresInternet: true, // Online lectures/resources
                    isWorkTask: true // NEW: Flag for work-related task (study is work for student)
                },
                {
                    id: 'study-for-class',
                    text: 'üìö Study for Class (2-3 hrs)',
                    details: 'Review course material and prepare for assignments',
                    time: 2,
                    effects: {energy: -10, stress: +5, growth: +10, mood: 'Inspired'},
                    message: 'Deep dive into textbooks. Brain power activated! üß†',
                    animation: {emoji: 'üìñ', class: 'study-anim', description: 'Focused on academics...'},
                    requiresInternet: true, // Online resources/submissions
                    isWorkTask: true // NEW: Flag for work-related task
                },
                {
                    id: 'send-job-applications',
                    text: 'üìß Send Job Applications',
                    details: 'Tailor resumes and cover letters for London jobs',
                    time: 2,
                    effects: {energy: -10, stress: +10, mood: 'Stressed'},
                    message: 'Applications sent! The job hunt continues... ü§û',
                    animation: {emoji: 'üìù', class: 'international-student-anim', description: 'Crafting job applications.'},
                    requiresInternet: true
                },
                {
                    id: 'check-ircc-updates',
                    text: 'üõÇ Check IRCC Policy Updates',
                    details: 'Stay informed on Canadian immigration news',
                    time: 1,
                    effects: {energy: -5, stress: +25, mood: 'Overwhelmed'}, // High stress due to uncertainty
                    message: 'IRCC updates... more changes, more uncertainty. üò©',
                    animation: {emoji: 'üì∞', class: 'international-student-anim', description: 'Navigating immigration policies.'},
                    requiresInternet: true
                },
                {
                    id: 'browse-social-media-student',
                    text: 'üì± Browse Social Media',
                    details: 'See what friends are up to, or get distracted',
                    time: 1,
                    effects: {energy: -5, stress: 'random', mood: 'Bored'}, // Will handle random stress in completeTask
                    message: 'Scrolling through feeds... feeling a mix of FOMO and relaxation. üì±',
                    animation: {emoji: 'ü§≥', class: 'social-media-anim', description: 'Mindless scrolling...'},
                    requiresInternet: true
                },
                {
                    id: 'call-home',
                    text: 'üìû Call Family Back Home',
                    details: 'Connect with your loved ones, they miss you',
                    time: 1,
                    effects: {energy: +10, stress: -5, mood: 'Happy'},
                    message: 'A heartwarming call home, they miss you too. ‚ù§Ô∏è',
                    animation: {emoji: 'üìû', class: 'international-student-anim', description: 'Bridging the distance...'},
                    requiresInternet: false // Phone call, not necessarily internet
                },
                {
                    id: 'budget-grocery-shopping-student',
                    text: 'üçú Budget Grocery Shopping',
                    details: 'Ramen vs. something more expensive at Food Basics',
                    time: 1,
                    effects: {energy: -10, money: -30, stress: +10, mood: 'Neutral'},
                    message: 'Ramen it is! The student dilemma is real. üçú',
                    animation: {emoji: 'üõí', class: 'grocery-anim', description: 'Sticking to the student budget...'},
                    requiresInternet: false
                },
                {
                    id: 'explore-london-landmarks',
                    text: 'üèõÔ∏è Explore London Landmarks',
                    details: 'Visit Dundas Street or other city spots',
                    time: 2,
                    effects: {energy: -5, stress: -10, mood: 'Happy'},
                    message: 'Explored some cool spots in London! Feeling more at home. üèõÔ∏è',
                    animation: {emoji: 'üö∂‚Äç‚ôÄÔ∏è', class: 'international-student-anim', description: 'Discovering the city.'},
                    requiresInternet: false
                },
                {
                    id: 'part-time-shift-student',
                    text: 'üí∞ Part-Time Shift (3-4 hrs)',
                    details: 'Work a few hours at your London job (Shoppers, Walmart, McD\'s)',
                    time: 3, // Average
                    effects: {energy: -20, money: +35, stress: +10, mood: 'Stressed'},
                    message: 'Earned some cash! Every dollar counts. üí∏',
                    animation: {emoji: 'üè™', class: 'work-anim', description: 'Balancing studies with work.'},
                    requiresInternet: false,
                    isWorkTask: true // NEW: Flag for work-related task
                },
                {
                    id: 'no-work-day',
                    text: 'üö´ No Work Today',
                    details: 'A day without a shift, saving energy but no income',
                    time: 0, // No time cost, just a placeholder for the day
                    effects: {energy: +5, stress: +5, money: +0, mood: 'Bored'}, // Slight stress from no income
                    message: 'No shift today. A bit of a financial hit, but some rest. üßò‚Äç‚ôÄÔ∏è',
                    animation: {emoji: 'üõå', class: 'nap-anim', description: 'A day off from work.'},
                    requiresInternet: false
                },
                {
                    id: 'last-minute-shift',
                    text: 'üìû Last-Minute Shift Call',
                    details: 'Manager needs you for an urgent 4-hour shift',
                    time: 4,
                    effects: {energy: -30, money: +50, stress: +25, mood: 'Overwhelmed'}, // High stress, good money
                    message: 'Unexpected shift! Good money, but threw off your plans.ü§Ø',
                    animation: {emoji: 'üèÉ‚Äç‚ôÄÔ∏è', class: 'work-anim', description: 'Rushing to a last-minute shift.'},
                    requiresInternet: false,
                    isWorkTask: true // NEW: Flag for work-related task
                },
                {
                    id: 'social-event-student',
                    text: 'üéâ Attend Student Social',
                    details: 'Meet new people and unwind',
                    time: 2,
                    effects: {energy: -10, stress: -15, socialLife: +25, mood: 'Happy'},
                    message: 'Had fun at the student social! Feeling more connected. üéâ',
                    animation: {emoji: 'ü•≥', class: 'social-media-anim', description: 'Making new friends and memories.'},
                    requiresInternet: false
                }
            ],
            'youtuber': [
                {
                    id: 'roblox-gameplay',
                    text: 'üéÆ Record Roblox Gameplay',
                    details: 'Capture exciting moments for your next video',
                    time: 3,
                    effects: {energy: -15, stress: +5, mood: 'Inspired'},
                    message: 'Got some great clips! Roblox adventures are the best. üéÆ',
                    animation: {emoji: 'üïπÔ∏è', class: 'youtuber-anim', description: 'Deep into the Robloxverse...'},
                    requiresInternet: true,
                    isWorkTask: true // NEW: Flag for work-related task
                },
                {
                    id: 'edit-roblox-video',
                    text: '‚úÇÔ∏è Edit Roblox Video',
                    details: 'Cut, add effects, and optimize for YouTube',
                    time: 4,
                    effects: {energy: -20, stress: +15, mood: 'Neutral'},
                    message: 'Hours of editing paid off. Video is looking sharp! ‚úÇÔ∏è',
                    animation: {emoji: 'üéûÔ∏è', class: 'youtuber-anim', description: 'Crafting the perfect video.'},
                    requiresInternet: true,
                    isWorkTask: true // NEW: Flag for work-related task
                },
                {
                    id: 'upload-roblox-video',
                    text: 'üöÄ Upload New Roblox Video',
                    details: 'Publish your latest creation to the world',
                    time: 1,
                    effects: {energy: -10, stress: +10, subscribers: +25, mood: 'Happy'}, // Base subscriber gain
                    message: 'Video live! Hope the Roblox community loves it! üöÄ',
                    animation: {emoji: '‚¨ÜÔ∏è', class: 'youtuber-anim', description: 'Sharing your masterpiece!'},
                    requiresInternet: true,
                    isWorkTask: true // NEW: Flag for work-related task
                },
                {
                    id: 'engage-comments-roblox',
                    text: 'üí¨ Engage with Comments',
                    details: 'Reply to fans and build community on your Roblox content',
                    time: 1,
                    effects: {energy: -5, stress: -5, subscribers: +10, mood: 'Happy'},
                    message: 'Replied to fans! Their support means everything. ‚ù§Ô∏è Subscribers increased!',
                    animation: {emoji: 'üó£Ô∏è', class: 'social-media-anim', description: 'Connecting with your gaming community.'},
                    requiresInternet: true
                },
                {
                    id: 'live-stream-roblox',
                    text: 'üî¥ Live Stream Roblox',
                    details: 'Interact with viewers in real-time',
                    time: 2,
                    effects: {energy: -25, stress: +20, subscribers: +35, money: +15, mood: 'Stressed'}, // Potential superchat money
                    message: 'Live stream was a blast! Viewers loved it.üî¥',
                    animation: {emoji: 'üéôÔ∏è', class: 'youtuber-anim', description: 'Broadcasting live to your fans!'},
                    requiresInternet: true,
                    isWorkTask: true // NEW: Flag for work-related task
                },
                {
                    id: 'research-roblox-trends',
                    text: 'üìà Research Roblox Trends',
                    details: 'Find out what\'s popular for new content ideas',
                    time: 1,
                    effects: {energy: -5, stress: +5, mood: 'Inspired'},
                    message: 'Stayed up-to-date on Roblox trends. Content ideas flowing! üí°',
                    animation: {emoji: 'üîç', class: 'study-anim', description: 'Analyzing the Roblox meta.'},
                    requiresInternet: true
                },
                {
                    id: 'collaborate-roblox-youtuber',
                    text: 'ü§ù Collaborate (Roblox YouTuber)',
                    details: 'Record a video with another Roblox creator',
                    time: 3,
                    effects: {energy: -20, stress: +10, subscribers: +50, socialLife: +20, mood: 'Happy'},
                    message: 'Awesome collab! New viewers are finding your channel. ü§ù',
                    animation: {emoji: 'üëØ', class: 'youtuber-anim', description: 'Teaming up for epic content!'},
                    requiresInternet: true,
                    isWorkTask: true // NEW: Flag for work-related task
                },
                {
                    id: 'deal-with-haters',
                    text: 'üò† Deal with Haters',
                    details: 'Respond to negative comments (or ignore them)',
                    time: 1,
                    effects: {energy: -10, stress: +25, mood: 'Overwhelmed'},
                    message: 'Some negativity today... but you\'re stronger than that. üò†',
                    animation: {emoji: 'üõ°Ô∏è', class: 'social-media-anim', description: 'Shaking off the negativity.'},
                    requiresInternet: true
                },
                {
                    id: 'monetize-content-youtuber',
                    text: 'üíµ Check Monetization',
                    details: 'Review ad revenue and potential sponsorships',
                    time: 1,
                    effects: {money: +80, stress: -5, mood: 'Happy'},
                    message: 'Ad revenue check! A nice boost to the bank account. üíµ',
                    animation: {emoji: 'üí≤', class: 'work-anim', description: 'Turning views into dollars.'},
                    requiresInternet: true,
                    isWorkTask: true // NEW: Flag for work-related task
                },
                {
                    id: 'plan-content-calendar',
                    text: 'üóìÔ∏è Plan Content Calendar',
                    details: 'Strategize future video releases',
                    time: 2,
                    effects: {energy: -10, stress: -5, mood: 'Inspired'},
                    message: 'Content calendar organized! Feeling productive. üóìÔ∏è',
                    animation: {emoji: 'üìù', class: 'study-anim', description: 'Mapping out your YouTube journey.'},
                    requiresInternet: true
                },
                {
                    id: 'community-poll',
                    text: 'üìä Community Poll',
                    details: 'Ask your audience for video ideas',
                    time: 1,
                    effects: {energy: -5, subscribers: +5, mood: 'Neutral'},
                    message: 'Community loves the poll! Great engagement. üìä',
                    animation: {emoji: 'üëç', class: 'social-media-anim', description: 'Listening to your fans.'},
                    requiresInternet: true
                }
            ],
            'nurse': [
                {
                    id: 'daycare-dropoff',
                    text: 'üë∂ Daycare Drop-off',
                    details: 'Take the kids to daycare before work/class.',
                    time: 1,
                    effects: {energy: -10, stress: +10, money: -15, kidHappiness: +5, mood: 'Neutral'},
                    message: 'Kids dropped off at daycare. Now, to catch that bus...',
                    animation: {emoji: 'üöå', class: 'family-task', description: 'Rushing to drop off the little ones.'},
                    appliesTo: ['shop-assistant', 'international-student', 'nurse'],
                    requiresKids: true,
                    triggerBusEvent: true // NEW: Flag to trigger the bus event
                },
                {
                    id: 'daycare-pickup',
                    text: 'üçº Daycare Pick-up',
                    details: 'Pick up the kids from daycare after your day.',
                    time: 1,
                    effects: {energy: -10, stress: +5, kidHappiness: +10, mood: 'Happy'},
                    message: 'Kids picked up! They\'re tired but happy to see you.',
                    animation: {emoji: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', class: 'family-task', description: 'Reuniting with the family.'},
                    appliesTo: ['shop-assistant', 'international-student', 'nurse'],
                    requiresKids: true
                },
                {
                    id: 'morning-huddle',
                    text: 'ü©∫ Morning Huddle',
                    details: 'Briefing with the medical team before your shift',
                    time: 0.5,
                    effects: {energy: -5, stress: +5, mood: 'Neutral'},
                    message: 'Morning huddle complete. Ready for the ward. ü©∫',
                    animation: {emoji: 'üìã', class: 'nurse-anim', description: 'Getting vital updates.'},
                    requiresInternet: false,
                    isWorkTask: true // NEW: Flag for work-related task
                },
                {
                    id: 'patient-rounds',
                    text: 'üßë‚Äç‚öïÔ∏è Patient Rounds',
                    details: 'Check on patients, administer meds, update charts',
                    time: 4,
                    effects: {energy: -30, stress: +20, money: +75, mood: 'Stressed'},
                    message: 'Busy rounds! Patients cared for, but you\'re feeling the pressure. üßë‚Äç‚öïÔ∏è',
                    animation: {emoji: 'üè•', class: 'nurse-anim', description: 'Providing essential care.'},
                    requiresInternet: false,
                    isWorkTask: true // NEW: Flag for work-related task
                },
                {
                    id: 'emergency-response',
                    text: 'üö® Emergency Response',
                    details: 'Handle an unexpected patient emergency',
                    time: 2,
                    effects: {energy: -40, stress: +40, mood: 'Overwhelmed'},
                    message: 'Crisis averted! But that was intense. üö®',
                    animation: {emoji: 'üöë', class: 'nurse-anim', description: 'Responding to a critical situation.'},
                    requiresInternet: false,
                    isWorkTask: true // NEW: Flag for work-related task
                },
                {
                    id: 'charting-documentation',
                    text: 'üìù Charting & Documentation',
                    details: 'Update patient records meticulously',
                    time: 3,
                    effects: {energy: -15, stress: +10, mood: 'Bored'},
                    message: 'Paperwork done. Essential, but tedious. üìù',
                    animation: {emoji: '‚úçÔ∏è', class: 'nurse-anim', description: 'Detailed record keeping.'},
                    requiresInternet: true, // Often electronic health records
                    isWorkTask: true // NEW: Flag for work-related task
                },
                {
                    id: 'team-collaboration',
                    text: 'ü§ù Team Collaboration',
                    details: 'Consult with doctors and other nurses',
                    time: 1,
                    effects: {energy: -5, stress: -10, socialLife: +15, mood: 'Happy'},
                    message: 'Good teamwork makes the dream work. Feeling supported. ü§ù',
                    animation: {emoji: 'üí¨', class: 'nurse-anim', description: 'Working together for patient care.'},
                    requiresInternet: false,
                    isWorkTask: true // NEW: Flag for work-related task
                },
                {
                    id: 'patient-education',
                    text: 'üó£Ô∏è Patient Education',
                    details: 'Explain treatment plans and care instructions',
                    time: 1.5,
                    effects: {energy: -10, stress: +5, mood: 'Inspired'},
                    message: 'Helped a patient understand their condition better. Rewarding. üó£Ô∏è',
                    animation: {emoji: 'üí°', class: 'nurse-anim', description: 'Empowering patients with knowledge.'},
                    requiresInternet: false,
                    isWorkTask: true // NEW: Flag for work-related task
                },
                {
                    id: 'lunch-break',
                    text: 'ü•™ Lunch Break (If you get one!)',
                    details: 'Quick meal to refuel',
                    time: 0.5,
                    effects: {energy: +15, stress: -5, mood: 'Neutral'},
                    message: 'A much-needed break. Food tastes better when you\'re starving. ü•™',
                    animation: {emoji: 'üçΩÔ∏è', class: 'nap-anim', description: 'A moment of peace.'},
                    requiresInternet: false
                }
            ]
        };

        // NEW: Pet-Specific Tasks
        const petTasks = [
            {
                id: 'feed-pet',
                text: 'üç≤ Feed Pet',
                details: 'Give your furry friend their meal.',
                time: 0.5,
                effects: {energy: -5, petHappiness: +15, stress: -5, mood: 'Happy'},
                message: 'Your pet is happily munching away! üêæ',
                animation: {emoji: 'üçñ', class: 'pet-care-anim', description: 'Keeping your pet well-fed.'},
                requiresPet: true,
                appliesTo: ['shop-assistant', 'international-student', 'youtuber', 'nurse'],
                requiresInternet: false
            },
            {
                id: 'play-with-pet',
                text: 'üéæ Play with Pet',
                details: 'Spend some quality time with your companion.',
                time: 1,
                effects: {energy: -10, petHappiness: +20, socialLife: +10, stress: -10, mood: 'Happy'},
                message: 'A great play session! Your pet loves you. ‚ù§Ô∏è',
                animation: {emoji: 'üêï', class: 'pet-care-anim', description: 'Fun with your furry friend.'},
                requiresPet: true,
                appliesTo: ['shop-assistant', 'international-student', 'youtuber', 'nurse'],
                requiresInternet: false
            },
            {
                id: 'groom-pet',
                text: 'üõÅ Groom Pet',
                details: 'Brush their fur or trim their nails.',
                time: 1.5,
                effects: {energy: -15, petHappiness: +10, stress: +5, mood: 'Neutral'},
                message: 'Pet grooming done. They look (and smell) much better! üßº',
                animation: {emoji: '‚úÇÔ∏è', class: 'pet-care-anim', description: 'Keeping your pet tidy.'},
                requiresPet: true,
                appliesTo: ['shop-assistant', 'international-student', 'youtuber', 'nurse'],
                requiresInternet: false
            }
        ];


        // NEW: Whims Database
        const whims = [
            {
                id: 'grab-coffee',
                text: '‚òï Grab a Coffee',
                details: 'Quick caffeine boost',
                time: 0.5,
                effects: {energy: +10, money: -5, stress: -5, mood: 'Happy'},
                message: 'Ah, coffee! Instant energy and a moment of peace. ‚òï',
                animation: {emoji: '‚òï', class: 'morning-routine-anim', description: 'A quick pick-me-up.'},
                requiresInternet: false
            },
            {
                id: 'quick-stretch',
                text: 'ü§∏ Quick Stretch',
                details: 'Loosen up those muscles',
                time: 0.5,
                effects: {energy: +5, stress: -5, mood: 'Neutral'},
                message: 'Feeling a bit more limber after that stretch. ü§∏',
                animation: {emoji: 'üßò', class: 'self-care-task', description: 'Taking a moment to breathe.'},
                requiresInternet: false
            },
            {
                id: 'listen-to-music',
                text: 'üéß Listen to Music',
                details: 'Put on some tunes to relax',
                time: 0.5,
                extraTime: 0.5, // Can take longer if you get lost in it
                effects: {stress: -10, mood: 'Happy'},
                message: 'Music always makes things better. üé∂',
                animation: {emoji: 'üéµ', class: 'social-media-anim', description: 'Grooving to the beat.'},
                requiresInternet: true
            },
            {
                id: 'check-news-headlines',
                text: 'üì∞ Check News Headlines',
                details: 'Stay informed, but avoid doomscrolling',
                time: 0.5,
                effects: {stress: 'random', mood: 'Neutral'}, // Can be positive or negative stress
                message: 'Briefly caught up on the news. Hope it was good news! üì∞',
                animation: {emoji: 'üóûÔ∏è', class: 'study-anim', description: 'Staying informed... or getting stressed.'},
                requiresInternet: true
            },
            {
                id: 'watch-funny-video', // MOVED FROM COMMON TASKS
                text: 'üòÇ Watch Funny Video',
                details: 'Quick break for some laughs',
                time: 0.5,
                effects: {energy: +5, stress: -5, mood: 'Happy'},
                message: 'That was hilarious! A much-needed laugh. üòÇ',
                animation: {emoji: 'üì∫', class: 'social-media-anim', description: 'Taking a mental break.'},
                requiresInternet: true
            },
            {
                id: 'meditate',
                text: 'üßò Meditate for 15 mins',
                details: 'Clear your mind and reduce stress',
                time: 0.25,
                effects: {energy: +5, stress: -15, mood: 'Happy'},
                message: 'A short meditation helped calm your mind. üßò',
                animation: {emoji: 'OM', class: 'self-care-task', description: 'Finding inner peace.'},
                requiresInternet: false
            },
            {
                id: 'quick-snack',
                text: 'üçé Quick Snack',
                details: 'Boost your energy with a healthy bite',
                time: 0.25,
                effects: {energy: +10, money: -2, mood: 'Neutral'},
                message: 'A healthy snack gave you a little boost. üçé',
                animation: {emoji: 'ü•™', class: 'morning-routine-anim', description: 'Fueling up quickly.'},
                requiresInternet: false
            }
        ];

        // NEW: Generic tasks to fill up the task list if job/pet tasks are not enough
        const genericFillerTasks = [
            {
                id: 'quick-walk',
                text: 'üö∂ Quick Walk Outside',
                details: 'Get some fresh air and clear your head',
                time: 1,
                effects: {energy: -5, stress: -10, mood: 'Happy'},
                message: 'A brisk walk helped you feel refreshed. üå≥',
                animation: {emoji: 'üö∂', class: 'self-care-task', description: 'Enjoying the outdoors.'},
                requiresInternet: false,
                appliesTo: ['shop-assistant', 'international-student', 'youtuber', 'nurse']
            },
            {
                id: 'organize-space',
                text: 'üóÑÔ∏è Organize Small Space',
                details: 'Tidy up a drawer or desk',
                time: 0.5,
                effects: {energy: -5, stress: -5, mood: 'Neutral'},
                message: 'Your space feels a bit more organized. ‚ú®',
                animation: {emoji: 'üóÇÔ∏è', class: 'chore-task', description: 'Bringing order to chaos.'},
                requiresInternet: false,
                appliesTo: ['shop-assistant', 'international-student', 'youtuber', 'nurse']
            },
            {
                id: 'plan-day',
                text: 'üóìÔ∏è Plan Tomorrow',
                details: 'Map out your tasks for the next day',
                time: 0.5,
                effects: {energy: -5, stress: -5, mood: 'Inspired'},
                message: 'Tomorrow\'s plan is set. Feeling prepared! üìù',
                animation: {emoji: 'üìÖ', class: 'study-anim', description: 'Strategizing for success.'},
                requiresInternet: false,
                appliesTo: ['shop-assistant', 'international-student', 'youtuber', 'nurse']
            },
            {
                id: 'stretch-break',
                text: 'ü§∏ Stretch Break',
                details: 'Light stretching to ease tension',
                time: 0.25,
                effects: {energy: +5, stress: -5, mood: 'Neutral'},
                message: 'A quick stretch helped loosen up. üßò',
                animation: {emoji: 'üôÜ', class: 'self-care-task', description: 'Releasing tension.'},
                requiresInternet: false,
                appliesTo: ['shop-assistant', 'international-student', 'youtuber', 'nurse']
            }
        ];

        // NEW: Specific "Off Day" Task
        const offDayTask = {
            id: 'day-off',
            text: 'üèñÔ∏è Enjoy Your Day Off!',
            details: 'No work today! Focus on yourself or family.',
            time: 0, // No time cost, just a placeholder
            effects: {energy: +10, stress: -10, mood: 'Happy'},
            message: 'What a relief! A well-deserved day off. üòå',
            animation: {emoji: '‚òÄÔ∏è', class: 'nap-anim', description: 'Relaxing and recharging.'},
            isWorkTask: false,
            requiresInternet: false,
            appliesTo: ['shop-assistant', 'international-student', 'nurse']
        };


        // NEW: Daily Dilemmas Database - with job and kid filters
        const dailyDilemmas = [
            { text: "The Toddler Tantrum & Work Deadline Disaster! Can you keep it together?", hasKids: true, job: ['shop-assistant', 'international-student', 'nurse'], requiresWork: true },
            { text: "Inflation Strikes! Can You Still Afford Groceries AND Daycare in London, ON?", hasKids: true, job: ['shop-assistant', 'international-student', 'nurse'] },
            { text: "Social Media Distraction Overload! Friends posting lavish vacations...", hasKids: false, job: ['shop-assistant', 'international-student', 'nurse'] }, // YouTuber has specific social media dilemma
            { text: "Unexpected Bill & A Kid's School Project Due! (London, ON edition)", hasKids: true, job: ['shop-assistant', 'international-student', 'nurse'] },
            { text: "London's job market is tight! Can you find enough work hours?", job: ['international-student', 'shop-assistant'], requiresWork: true },
            { text: "Western University midterms are looming! Can you balance studies and life?", job: ['international-student'], requiresWork: true },
            { text: "Your latest Roblox video isn't gaining traction. How do you boost views?", job: ['youtuber'], requiresWork: true },
            { text: "A critical patient needs your immediate attention! High stakes, high pressure.", job: ['nurse'], requiresWork: true },
            { text: "A major Roblox update just dropped! Time to adapt your content?", job: ['youtuber'], requiresWork: true },
            { text: "You're feeling emotionally drained after a tough shift. How do you cope?", job: ['nurse'], requiresWork: true },
            { text: "You feel homesick in London, ON. How do you cope?", job: ['international-student'] },
            { text: "Your shop is understaffed. Expect a busy day!", job: ['shop-assistant'], requiresWork: true },
            { text: "London's transit is delayed! Your commute is longer than usual.", job: ['international-student', 'shop-assistant', 'nurse'], hasKids: false, requiresWork: true }, // General London issue
            { text: "Roblox game servers are down! Your content plans are ruined!", job: ['youtuber'], requiresWork: true },
            { text: "A new immigration policy update from IRCC. Is it good or bad news?", job: ['international-student'], requiresWork: true },
            { text: "Leaky Faucet! Your sink is dripping constantly, driving up your water bill.", hasKids: false, job: ['shop-assistant', 'international-student', 'youtuber', 'nurse'] },
            { text: "Internet Outage! Your Wi-Fi is down, affecting work/study/entertainment.", hasKids: false, job: ['shop-assistant', 'international-student', 'youtuber', 'nurse'] }
        ];

        // ===============================================
        // RANDOM EVENTS DATABASE (Now "Emergency Meetings")
        // ===============================================
        const randomEvents = [
            // TODDLER MELTDOWN MOVED TO BE TRIGGERED BY GROCERY SHOPPING
            {
                title: 'Emergency Meeting! üí∏ Surprise Medical Bill!',
                description: 'You received an unexpected medical bill for $120. Your insurance didn\'t cover everything...',
                choices: [
                    {
                        text: 'üí≥ Pay Immediately',
                        effects: {money: -120, stress: +10, mood: 'Stressed'},
                        message: 'Bill paid, but your budget is now tighter than ever.'
                    },
                    {
                        text: 'üìû Call for Payment Plan',
                        effects: {money: -30, stress: +20, mood: 'Overwhelmed'},
                        message: 'Payment plan arranged, but the debt stress is real.'
                    },
                    {
                        text: 'üìÖ Ignore for Now',
                        effects: {stress: +35, mood: 'Stressed'},
                        message: 'You\'ll deal with it later, but it\'s weighing on your mind...'
                    }
                ],
                requiresWork: false // This event can happen regardless of work status
            },
            {
                title: 'Emergency Meeting! üì±‚ú® Social Media Envy!',
                description: 'Your friend posted vacation photos from Hawaii. Meanwhile, you\'re budgeting for groceries...',
                hasKids: false, // Only for those without kids (shop-assistant, int student, nurse)
                job: ['shop-assistant', 'international-student', 'nurse'],
                choices: [
                    {
                        text: 'üòî Feel Inadequate',
                        effects: {stress: +25, mood: 'Stressed'},
                        message: 'The comparison game is cruel. You feel like you\'re failing.'
                    },
                    {
                        text: 'ü§∑ Shrug It Off',
                        effects: {stress: +10, mood: 'Neutral'},
                        message: 'Everyone has their own struggles. You focus on your blessings.'
                    },
                    {
                        text: '‚ù§Ô∏è Comment Supportively',
                        effects: {stress: +5, mood: 'Happy', socialLife: +5},
                        message: 'You genuinely celebrated their joy. Kindness always wins.'
                    }
                ],
                requiresWork: false // Can happen on off days
            },
            {
                title: 'Emergency Meeting! üë∂üö® Childcare Crisis!',
                description: 'Your regular babysitter cancelled last minute! You have to work/attend class today...',
                hasKids: true,
                choices: [
                    {
                        text: 'üìû Call Friends for Help',
                        effects: {energy: -10, stress: +20, socialLife: -5, mood: 'Stressed'}, // Friends might be annoyed
                        message: 'You called friends, but they were busy. You feel a bit more stressed and alone.'
                    },
                    {
                        text: 'üëµ Emergency Grandparents (if available)',
                        effects: {energy: -10, stress: +15, mood: 'Neutral'},
                        message: 'Grandparents saved the day! You owe them dinner.'
                    },
                    {
                        text: '‚ùå Call in Sick / Cancel Class', // NEW: Combined for work/class
                        effects: {
                            energy: -30,
                            stress: 'severeCrisis', // Custom effect for severe stress/consequence
                            mood: 'Overwhelmed',
                            jobConsequence: true // Flag for job/class specific penalty
                        },
                        message: 'You had to call in sick/cancel class. The immediate relief is overshadowed by immense stress and future worries.'
                    },
                    {
                        text: 'üè¢ Bring Kids to Work/Class (Last Resort)',
                        effects: {energy: -30, stress: +40, kidHappiness: -10, mood: 'Stressed'},
                        message: 'Desperate times... Your boss/professor was NOT happy, and your kids are restless.'
                    }
                ],
                requiresWork: true // This event implies you *need* to work/attend class
            },
            // Job-specific events
            {
                title: 'Emergency Meeting! üìö Exam Stress!',
                description: 'You have a major exam at Western University tomorrow, but you\'re exhausted.',
                job: 'international-student',
                choices: [
                    { text: '‚òï Pull an All-Nighter', effects: {energy: -30, stress: +20, growth: +15, mood: 'Stressed'}, message: 'You crammed all night. Hope it pays off!' },
                    { text: 'üò¥ Get Some Sleep', effects: {energy: +20, stress: -10, growth: -5, mood: 'Neutral'}, message: 'Prioritized sleep. You\'ll do your best.' }
                ],
                requiresWork: true // Exams are part of the "work" of a student
            },
            {
                title: 'Emergency Meeting! üìà Roblox Video Goes Viral?',
                description: 'One of your old Roblox videos is suddenly gaining a lot of views! What do you do?',
                job: 'youtuber',
                choices: [
                    { text: 'üöÄ Capitalize Now!', effects: {energy: -10, stress: +10, subscribers: +50, money: +20, mood: 'Inspired'}, message: 'You rode the wave! More subs and some cash!' },
                    { text: 'üßò‚Äç‚ôÄÔ∏è Stick to Schedule', effects: {stress: -5, subscribers: +10, mood: 'Neutral'}, message: 'You stuck to your plan. Steady growth is good.' }
                ],
                requiresWork: true // This is directly related to YouTube work
            },
            {
                title: 'Emergency Meeting! üö® Patient Deterioration!',
                description: 'A patient\'s condition is worsening rapidly. You need to act fast and make critical decisions.',
                job: 'nurse',
                choices: [
                    { text: 'üìû Call for Backup', effects: {energy: -20, stress: +30, mood: 'Overwhelmed'}, message: 'You called for help. The situation is under control, but it was a close call.' },
                    { text: 'üí™ Handle it Alone', effects: {energy: -50, stress: +50, mood: 'Stressed'}, message: 'You managed it, but the immense pressure took a toll. This is why nurses burn out.' }
                ],
                requiresWork: true // This is a work-specific event for nurses
            },
            {
                title: 'Emergency Meeting! üìß Job Rejection!',
                description: 'You just received a disheartening rejection email for a job you really wanted in London, ON.',
                job: 'international-student',
                choices: [
                    {
                        text: 'üòî Feel Demotivated',
                        effects: {stress: +30, energy: -10, mood: 'Stressed'},
                        message: 'That stings. It\'s hard not to take it personally.'
                    },
                    {
                        text: 'üí™ Keep Applying!',
                        effects: {stress: +15, energy: -5, mood: 'Neutral'},
                        message: 'A setback, but you\'re resilient. Onward to the next application!'
                    }
                ],
                requiresWork: false // Can happen anytime, but tied to job hunting
            },
            {
                title: 'Emergency Meeting! üé≤ Lottery Win?!',
                description: 'You bought a lottery ticket... and it\'s a winner! How much?',
                choices: [
                    { text: 'üí∞ Small Win ($10)', effects: {money: +10, stress: -2, mood: 'Happy'}, message: 'A small win! Every bit helps. üéâ' },
                    { text: 'ü§ë Medium Win ($50)', effects: {money: +50, stress: -5, mood: 'Happy'}, message: 'A decent win! Nice surprise! ü•≥' },
                    { text: 'üí∏ Big Win ($200)', effects: {money: +200, stress: -10, mood: 'Happy'}, message: 'Wow! A significant win! Time to pay some bills! ü§ë' },
                    { text: 'ü§∑‚Äç‚ôÄÔ∏è No Win', effects: {stress: +5, mood: 'Bored'}, message: 'No luck this time. Back to reality. üòî' }
                ],
                requiresWork: false // Can happen anytime
            },
            {
                title: 'Emergency Meeting! üåê Internet Outage!',
                description: 'Your internet is suddenly down! This will affect many of your daily tasks...',
                choices: [
                    {
                        text: 'üò´ Panic & Stress',
                        effects: {stress: +30, mood: 'Overwhelmed', internetDown: true},
                        message: 'The internet is down! This is a nightmare! Many tasks are now impossible.'
                    },
                    {
                        text: 'üßò‚Äç‚ôÄÔ∏è Find Offline Alternatives',
                        effects: {stress: +10, mood: 'Neutral', internetDown: true},
                        message: 'Internet is out, but you\'ll adapt. Time to find some offline tasks.'
                    }
                ],
                requiresWork: false // Can happen anytime
            },
            {
                title: 'Emergency Meeting! üêæ Pet Chaos!',
                description: 'Your neglected pet has run rampant! They chewed up your favorite shoes / scratched the furniture / knocked over a plant!',
                requiresPet: true,
                choices: [
                    {
                        text: 'üò† Get Angry',
                        effects: {stress: +25, money: -30, petHappiness: -10, mood: 'Stressed'},
                        message: 'You yelled at your pet. They look sad, and now you have to pay for repairs.'
                    },
                    {
                        text: 'üßπ Clean Up & Forgive',
                        effects: {stress: +15, money: -30, petHappiness: +5, mood: 'Neutral'},
                        message: 'You sighed, cleaned up the mess, and gave your pet a hug. Still costs money though.'
                    }
                ],
                requiresWork: false // Can happen anytime
            },
            // NEW: Scam Call Event
            {
                title: 'Emergency Meeting! üìû Scam Call!',
                description: 'Your phone rings, it\'s an unknown number with a London, ON area code. It could be a scam or important!',
                choices: [
                    {
                        text: 'üìû Pick Up (Risk it)',
                        effects: {money: -10, stress: +15, mood: 'Stressed'},
                        message: 'It was a scam call! You lost $10 and felt annoyed. üò†'
                    },
                    {
                        text: 'üîï Let it go to voicemail',
                        effects: {stress: -5, mood: 'Neutral'},
                        message: 'You let it go. Better safe than sorry. üòå'
                    }
                ],
                requiresWork: false // Can happen anytime
            }
        ];

        // NEW: London Bus Dilemma Event
        const londonBusDilemma = {
            title: 'Emergency Meeting! üöå Missed the Bus!',
            description: 'You just dropped off the kids at daycare, but you missed your bus by *that* much! The next one is in 20 minutes...',
            requiresWork: true, // This event only happens if you are going to work/class
            choices: {
                'shop-assistant': [
                    {
                        text: 'Wait for the next bus (and be late for work)',
                        effects: {time: 0.5, stress: +20, mood: 'Stressed', futureShiftPenalty: true}, // 0.5 hr = 30 mins
                        message: 'You waited for the next bus. Your boss won\'t be thrilled about you being late. Expect fewer shifts tomorrow!'
                    },
                    {
                        text: 'Call a cab (expensive, but on time!)',
                        effects: {money: -25, stress: -5, mood: 'Neutral'},
                        message: 'You shelled out for a cab. Ouch, but at least you\'re on time.'
                    }
                ],
                'international-student': [
                    {
                        text: 'Wait for the next bus (and be late for class)',
                        effects: {time: 0.5, stress: 'randomClassConsequence', mood: 'Overwhelmed'}, // Will trigger specific class consequence
                        message: 'You waited for the next bus. Being late for class is never a good look...'
                    },
                    {
                        text: 'Call a cab (expensive, but on time!)',
                        effects: {money: -25, stress: -5, mood: 'Neutral'},
                        message: 'You hailed a cab. Your wallet is lighter, but your attendance record is safe.'
                    }
                ],
                'nurse': [ // Updated for Nurse
                    {
                        text: 'Wait for the next bus (and be late for shift)',
                        effects: {time: 0.5, stress: +25, mood: 'Stressed', futureShiftPenalty: true},
                        message: 'You waited for the next bus. Being late for a nursing shift is serious. Expect a stern talking-to and potentially less favorable shifts.'
                    },
                    {
                        text: 'Call a cab (expensive, but on time!)',
                        effects: {money: -25, stress: -5, mood: 'Neutral'},
                        message: 'You took a cab to the hospital. Costly, but you arrived on time and avoided issues.'
                    }
                ]
            }
        };

        // NEW: Toddler Meltdown Event (triggered only by grocery shopping)
        const toddlerMeltdownEvent = {
            title: 'Emergency Meeting! üë∂üò≠ Toddler Meltdown!',
            description: 'Your toddler is having a complete meltdown in the grocery store. Other shoppers are staring...',
            choices: [
                {
                    text: 'ü§ó Comfort Immediately',
                    effects: {energy: -20, stress: +10, kidHappiness: +15, mood: 'Overwhelmed'},
                    message: 'You calmed them down with patience and love. Crisis averted!'
                },
                {
                    text: '‚è∞ Wait It Out',
                    effects: {energy: -10, stress: +25, kidHappiness: -5, mood: 'Stressed'},
                    message: 'You waited it out, but the judgment from other parents stings...'
                },
                {
                    text: 'üèÉ Leave Store Immediately',
                    effects: {energy: -15, stress: +20, kidHappiness: +5, mood: 'Stressed'},
                    message: 'You left without groceries. Sometimes retreat is the best strategy.'
                }
            ],
            requiresWork: false // Not work-related
        };


        // ===============================================
        // SCREEN MANAGEMENT FUNCTIONS
        // ===============================================
        function showScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });

            // Show target screen with animation
            const targetScreen = document.getElementById(screenId);
            targetScreen.classList.add('active');
        }

        function showHowToPlay() {
            const instructions = `
üéØ GOAL: Balance work, family, and personal well-being in today's challenging economy!

üìä MANAGE YOUR RESOURCES:
‚Ä¢ Energy: Complete tasks and rest when needed
‚Ä¢ Money: Earn through work, spend on necessities  
‚Ä¢ Stress: Watch your mental health
‚Ä¢ Kid Happiness/Subscribers: Keep your children content OR grow your online audience!
‚Ä¢ Mood: Your emotional state affects resource changes.
‚Ä¢ Social Life: Maintain connections for overall well-being.
‚Ä¢ Pet Happiness: Keep your furry friend happy to avoid chaos!

üìù COMPLETE DAILY TASKS:
‚Ä¢ Each task takes time and affects your resources
‚Ä¢ Choose wisely - you can't do everything!
‚Ä¢ Look out for "Whims" for quick boosts!

üé≤ HANDLE RANDOM EVENTS:
‚Ä¢ Life throws curveballs - make tough choices
‚Ä¢ Every decision has consequences

üí° REAL-WORLD LESSONS:
‚Ä¢ Experience the challenges of modern parenting/career paths
‚Ä¢ Learn about budgeting and time management
‚Ä¢ Understand the hidden costs of life in a new city or online world

Remember: There's no perfect way to balance everything. Do your best and be kind to yourself! üíô
            `;

            // Use the generic showModal function with 'random-event-modal' ID for instructions
            showModal('How to Play', instructions, [{text: 'Got It!', action: () => hideModal('random-event-modal')}]);
        }

        // NEW: Character selection logic
        function selectJob(jobType) {
            selectedJob = jobType;
            document.querySelectorAll('#job-selection-grid .character-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`.character-card[data-job="${jobType}"]`).classList.add('selected');

            // Disable kids selection if YouTuber is chosen
            const kidsGroup = document.getElementById('num-kids-group');
            if (jobType === 'youtuber') {
                kidsGroup.style.opacity = '0.5';
                kidsGroup.style.pointerEvents = 'none';
                selectedKids = 0; // Force 0 kids for YouTuber
                document.querySelectorAll('#kids-selection-grid .character-card').forEach(card => {
                    card.classList.remove('selected');
                });
                document.querySelector(`.character-card[data-kids="0"]`).classList.add('selected');
            } else {
                kidsGroup.style.opacity = '1';
                kidsGroup.style.pointerEvents = 'auto';
            }
        }

        function selectKids(num) {
            selectedKids = num;
            document.querySelectorAll('#kids-selection-grid .character-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`.character-card[data-kids="${num}"]`).classList.add('selected');
        }

        function selectPet(petType) {
            selectedPet = petType;
            document.querySelectorAll('#pet-selection-grid .character-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`.character-card[data-pet="${petType}"]`).classList.add('selected');
        }


        // ===============================================
        // GAME INITIALIZATION & PLAYABILITY CHECK
        // ===============================================

        // Called once on page load
        document.addEventListener('DOMContentLoaded', () => {
            checkPlayabilityAndLoadGame();
        });

        function checkPlayabilityAndLoadGame() {
            const lastGameEnd = localStorage.getItem('lastGameEnd');
            const savedState = loadGameState();
            const now = new Date().getTime();

            if (lastGameEnd) {
                const timeElapsed = now - parseInt(lastGameEnd);
                const cooldownMillis = COOLDOWN_HOURS * 60 * 60 * 1000;

                if (timeElapsed < cooldownMillis) {
                    // Cooldown is active, show countdown
                    startCooldownCountdown(cooldownMillis - timeElapsed);
                    return; // Stop further initialization
                } else {
                    // Cooldown has passed
                    if (savedState) {
                        // Offer to resume game
                        showModal(
                            'Welcome Back!',
                            `Welcome back, ${savedState.playerName}! Do you want to resume your chaotic story from Day ${savedState.day}?`,
                            [
                                { text: 'Resume Game', action: () => resumeGame(savedState) },
                                { text: 'Start New Game', action: () => { clearGameState(); showCharacterCreationScreen(); } } // Call new function
                            ],
                            'playability-modal'
                        );
                        return; // Wait for user choice
                    }
                }
            }

            // Default: No cooldown, no save, show the start screen
            showScreen('start-screen');
            // Ensure initial selections are made or highlighted for new game
            selectJob(selectedJob || 'shop-assistant');
            selectKids(selectedKids !== null ? selectedKids : 0);
            selectPet(selectedPet || 'none');
        }

        // NEW: Function to show character creation screen
        function showCharacterCreationScreen() {
            showScreen('character-creation-screen');
            // Ensure initial selections are made or highlighted
            selectJob(selectedJob || 'shop-assistant');
            selectKids(selectedKids !== null ? selectedKids : 0);
            selectPet(selectedPet || 'none');
        }

        function startCooldownCountdown(initialTimeLeft) {
            const modal = document.getElementById('playability-modal');
            const titleElement = modal.querySelector('.modal-title');
            const messageElement = modal.querySelector('.modal-text');
            const okButton = modal.querySelector('.btn');

            titleElement.textContent = 'Game Cooldown Active';
            okButton.textContent = 'Okay';
            okButton.onclick = () => hideModal('playability-modal'); // Allow closing, but countdown continues

            modal.classList.add('active'); // Show modal

            // Clear any existing interval to prevent multiple countdowns
            if (cooldownIntervalId) {
                clearInterval(cooldownIntervalId);
            }

            let timeLeft = initialTimeLeft;

            const updateCountdown = () => {
                if (timeLeft <= 0) {
                    clearInterval(cooldownIntervalId);
                    cooldownIntervalId = null; // Clear the ID
                    hideModal('playability-modal');
                    // Cooldown finished, now check for saved game or go to character creation
                    const savedState = loadGameState();
                    if (savedState) {
                        showModal(
                            'Welcome Back!',
                            `Welcome back, ${savedState.playerName}! Do you want to resume your chaotic story from Day ${savedState.day}?`,
                            [
                                { text: 'Resume Game', action: () => resumeGame(savedState) },
                                { text: 'Start New Game', action: () => { clearGameState(); showCharacterCreationScreen(); } }
                            ],
                            'playability-modal'
                        );
                    } else {
                        showScreen('start-screen');
                        selectJob(selectedJob || 'shop-assistant');
                        selectKids(selectedKids !== null ? selectedKids : 0);
                        selectPet(selectedPet || 'none');
                    }
                    return;
                }

                const hoursLeft = Math.floor(timeLeft / (1000 * 60 * 60));
                const minutesLeft = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const secondsLeft = Math.floor((timeLeft % (1000 * 60)) / 1000);

                messageElement.textContent = `You've played too recently! Please wait ${hoursLeft}h ${minutesLeft}m ${secondsLeft}s before starting a new game.`;

                timeLeft -= 1000; // Decrement by 1 second
            };

            updateCountdown(); // Call immediately to show initial time
            cooldownIntervalId = setInterval(updateCountdown, 1000);
        }


        function startNewGame() {
            const playerName = document.getElementById('player-name').value.trim() || 'Player';

            // Validate selections
            if (!selectedJob || selectedKids === null || selectedPet === null) {
                showModal('Selection Required', 'Please choose a job, number of kids, and a pet type to start the game.', [{text: 'Okay', action: () => hideModal('random-event-modal')}]);
                return;
            }

            // Reset game state for a NEW game
            gameState = {
                playerName: playerName,
                numKids: selectedKids,
                job: selectedJob,
                petType: selectedPet,
                day: 1,
                time: 7,
                energy: 100,
                money: 500,
                stress: 0,
                socialLife: 70,
                petHappiness: 100,
                mood: 'Neutral',
                milestoneAchieved: false,
                completedTasks: [],
                tasksCompletedToday: 0,
                procrastinatusActive: false,
                activeWhims: [],
                billsDue: [
                    { id: 'rent', name: 'Rent', amount: 500, dueDate: 5, paid: false },
                    { id: 'utilities', name: 'Utilities', amount: 80, dueDate: 7, paid: false },
                    { id: 'internet', name: 'Internet Bill', amount: 60, dueDate: 3, paid: false }
                ],
                missedDeadlines: [],
                internetDown: false,
                nextDayShiftPenalty: false,
                nextDayLectureConsequence: null,
                isWorkingToday: false, // NEW: Initialize as false
                isOffDay: false // NEW: Initialize as false
            };

            // Initialize dynamic resource based on job
            if (gameState.job === 'youtuber') {
                gameState.subscribers = 30;
                delete gameState.kidHappiness;
            } else {
                gameState.kidHappiness = 80;
                delete gameState.subscribers;
            }

            if (gameState.petType !== 'none') {
                gameState.petHappiness = 100;
            } else {
                delete gameState.petHappiness;
            }

            // Adjust starting resources based on family size (if applicable for current job)
            if (gameState.job !== 'youtuber' && gameState.numKids > 0) {
                if (gameState.numKids === 1) {
                    gameState.energy = 90;
                    gameState.stress = 10;
                    gameState.kidHappiness = 85;
                } else if (gameState.numKids === 2) {
                    gameState.energy = 80;
                    gameState.stress = 20;
                    gameState.kidHappiness = 70;
                }
            }

            showScreen('daily-dashboard'); // Show screen BEFORE updating UI and populating tasks
            updateUI(); // Update UI with initial game state
            populateTasks(); // Populate tasks for the new day
            displayDailyDilemma(); // Display the first daily dilemma
            generateWhims(); // Generate initial whims
            saveGameState(); // Save initial game state for new game
        }

        function resumeGame(savedState) {
            gameState = savedState; // Restore game state
            updateUI(); // Update UI with restored state
            populateTasks(); // Repopulate tasks based on restored state
            displayDailyDilemma(); // Display dilemma for current day
            generateWhims(); // Generate whims
            showScreen('daily-dashboard'); // Go to dashboard
            hideModal('playability-modal'); // Hide the welcome back modal
            showFeedback(`Welcome back, ${gameState.playerName}! Resuming your story on Day ${gameState.day}.`);
        }

        function saveGameState() {
            try {
                localStorage.setItem('myChaoticStorySave', JSON.stringify(gameState));
                console.log('Game state saved.');
            } catch (e) {
                console.error('Error saving game state:', e);
                showFeedback('Error saving game progress. Please check browser storage settings.');
            }
        }

        function loadGameState() {
            try {
                const savedState = localStorage.getItem('myChaoticStorySave');
                if (savedState) {
                    return JSON.parse(savedState);
                }
            } catch (e) {
                console.error('Error loading game state:', e);
                // If parsing fails, clear the corrupted save
                localStorage.removeItem('myChaoticStorySave');
                showFeedback('Corrupted save file detected and cleared. Starting new game.');
            }
            return null;
        }

        function clearGameState() {
            localStorage.removeItem('myChaoticStorySave');
            localStorage.removeItem('lastGameEnd'); // Clear cooldown too if starting fresh
            console.log('Game state cleared.');
        }

        // ===============================================
        // UI UPDATE FUNCTIONS
        // ===============================================
        function updateUI() {
            // Update clock
            const hours = gameState.time % 12 === 0 ? 12 : gameState.time % 12;
            const ampm = gameState.time < 12 || gameState.time === 24 ? 'AM' : 'PM';

            const gameClockElement = document.getElementById('game-clock');
            if (gameClockElement) {
                gameClockElement.textContent = `Day ${gameState.day}: ${hours}:00 ${ampm}`;
            }

            // Update body background based on time of day
            const body = document.body;
            body.classList.remove('day-morning', 'day-afternoon', 'day-evening', 'day-night');
            if (gameState.time >= 6 && gameState.time < 12) {
                body.classList.add('day-morning');
            } else if (gameState.time >= 12 && gameState.time < 17) {
                body.classList.add('day-afternoon');
            } else if (gameState.time >= 17 && gameState.time < 21) {
                body.classList.add('day-evening');
            } else {
                body.classList.add('day-night');
            }


            // Update Energy, Money, Stress
            // Round energy, stress, subscribers to whole numbers
            document.getElementById('energy-value').textContent = `${Math.round(Math.max(0, gameState.energy))}%`;
            document.getElementById('energy-bar').style.width = `${Math.round(Math.max(0, gameState.energy))}%`;
            // NEW: Low energy visual indicator
            const energyResourceContainer = document.getElementById('energy-resource-container');
            if (energyResourceContainer) {
                if (gameState.energy <= 20) {
                    energyResourceContainer.classList.add('low-energy');
                } else {
                    energyResourceContainer.classList.remove('low-energy');
                }
            }


            document.getElementById('money-value').textContent = `$${Math.max(0, gameState.money)}`;

            document.getElementById('stress-value').textContent = `${Math.round(Math.max(0, gameState.stress))}%`;
            document.getElementById('stress-bar').style.width = `${Math.round(Math.max(0, gameState.stress))}%`;

            // Update Dynamic Resource (Kid Happiness or Subscribers)
            const dynamicResourceIcon = document.getElementById('dynamic-resource-icon');
            const dynamicResourceLabel = document.getElementById('dynamic-resource-label');
            const dynamicResourceValue = document.getElementById('dynamic-resource-value');
            const dynamicResourceBar = document.getElementById('dynamic-resource-bar');
            const dynamicResourceContainer = document.getElementById('dynamic-resource');

            if (gameState.job === 'youtuber') {
                dynamicResourceIcon.textContent = '‚ñ∂Ô∏è'; // YouTube Play Button
                dynamicResourceLabel.textContent = 'Subscribers';
                dynamicResourceValue.textContent = `${Math.round(Math.max(0, gameState.subscribers))}`;
                dynamicResourceBar.style.width = `${Math.min(100, Math.round(gameState.subscribers / 20))}%`; // Scale for bar (e.g., 2000 subs = 100%)
                dynamicResourceBar.className = 'resource-bar-fill subscribers-bar'; // Apply new bar color
                dynamicResourceContainer.style.display = 'block'; // Ensure it's visible

                // Check for Subscriber Milestone
                if (gameState.subscribers >= 1000 && !gameState.milestoneAchieved) {
                    gameState.milestoneAchieved = true;
                    showModal(
                        'üéâ Congratulations! üéâ',
                        'You\'ve hit 1,000 subscribers! Your channel is officially monetized and growing! Keep up the great content!',
                        [{text: 'Awesome!', action: () => hideModal('random-event-modal')}]
                    );
                }

            } else if (gameState.numKids > 0) {
                dynamicResourceIcon.textContent = 'üòä';
                dynamicResourceLabel.textContent = 'Kid Happiness';
                dynamicResourceValue.textContent = `${Math.round(Math.max(0, gameState.kidHappiness))}%`;
                dynamicResourceBar.style.width = `${Math.round(Math.max(0, gameState.kidHappiness))}%`;
                dynamicResourceBar.className = 'resource-bar-fill happiness-bar'; // Apply happiness bar color
                dynamicResourceContainer.style.display = 'block'; // Ensure it's visible
            } else {
                dynamicResourceContainer.style.display = 'none'; // Hide if no kids and not a YouTuber
            }

            // Update Social Life
            document.getElementById('social-value').textContent = `${Math.round(Math.max(0, gameState.socialLife))}%`;
            document.getElementById('social-bar').style.width = `${Math.round(Math.max(0, gameState.socialLife))}%`;

            // NEW: Update Pet Happiness
            const petResourceContainer = document.getElementById('pet-resource');
            const petIcon = document.getElementById('pet-icon');
            const petHappinessValue = document.getElementById('pet-happiness-value');
            const petHappinessBar = document.getElementById('pet-happiness-bar');

            if (gameState.petType !== 'none') {
                petResourceContainer.style.display = 'block';
                petIcon.textContent = gameState.petType === 'dog' ? 'üê∂' : 'üê±';
                petHappinessValue.textContent = `${Math.round(Math.max(0, gameState.petHappiness))}%`;
                petHappinessBar.style.width = `${Math.round(Math.max(0, gameState.petHappiness))}%`;
            } else {
                petResourceContainer.style.display = 'none';
            }


            // Update Mood Display
            const moodDisplayElement = document.getElementById('mood-display');
            let moodEmoji = '';
            switch (gameState.mood) {
                case 'Happy': moodEmoji = 'üòÑ'; break;
                case 'Stressed': moodEmoji = 'üò©'; break;
                case 'Bored': moodEmoji = 'üòê'; break;
                case 'Inspired': moodEmoji = 'üí°'; break;
                case 'Overwhelmed': moodEmoji = 'ü§Ø'; break;
                default: moodEmoji = 'üòê';
            }
            moodDisplayElement.textContent = `Mood: ${gameState.mood} ${moodEmoji}`;


            // Ensure values don't go below 0 or above 100 (except money, subscribers)
            gameState.energy = Math.min(100, Math.max(0, gameState.energy));
            gameState.stress = Math.min(100, Math.max(0, gameState.stress));
            gameState.socialLife = Math.min(100, Math.max(0, gameState.socialLife));
            if (gameState.petType !== 'none') {
                gameState.petHappiness = Math.min(100, Math.max(0, gameState.petHappiness));
            }


            if (gameState.job === 'youtuber') {
                gameState.subscribers = Math.max(0, gameState.subscribers); // Subscribers can't go negative
            } else {
                gameState.kidHappiness = Math.min(100, Math.max(0, gameState.kidHappiness));
            }

            // Check if energy is 0 or less to end the day
            if (gameState.energy <= 0 && document.getElementById('daily-dashboard').classList.contains('active')) {
                // NEW: Show energy depleted modal instead of directly ending day
                showModal('üîã Energy Depleted!', 'You\'ve run out of energy for the day. Time to rest!', [{text: 'End Day', action: () => { hideModal('energy-depleted-modal'); endDay(); }}], 'energy-depleted-modal');
            }
            // NEW: Check if stress is 100 or more to end the day
            if (gameState.stress >= 100 && document.getElementById('daily-dashboard').classList.contains('active')) {
                // The error was here: 'stress-depleted-modal' was not in the HTML
                showModal('ü§Ø Burnout!', 'Your stress levels are too high! You\'ve reached burnout. Time to take a break!', [{text: 'End Day', action: () => { hideModal('stress-depleted-modal'); endDay(); }}], 'stress-depleted-modal');
            }


            // Update End of Day Summary screen values
            const summaryDayNumberElement = document.getElementById('summary-day-number');
            if (summaryDayNumberElement) {
                summaryDayNumberElement.textContent = gameState.day;
            }
        }

        function showFeedback(message) {
            const feedbackArea = document.getElementById('feedback-area');
            if (feedbackArea) {
                feedbackArea.textContent = message;
                feedbackArea.classList.add('feedback');
                setTimeout(() => {
                    feedbackArea.classList.remove('feedback');
                    feedbackArea.textContent = '';
                }, 3000);
            }
        }

        // ===============================================
        // TASK MANAGEMENT & DIFFICULTY
        // ===============================================

        // NEW: Function to get difficulty multiplier based on day
        function getDifficultyMultiplier() {
            if (gameState.day === 1) return 1; // Day 1 is easy
            if (gameState.day >= 7) return 2.0; // Day 7 and beyond is hardest
            if (gameState.day >= 5) return 1.7; // Day 5 is very hard
            if (gameState.day >= 3) return 1.4; // Day 3 is harder
            return 1.1 + (gameState.day * 0.1); // Gradual increase for other days
        }


        function populateTasks() {
            const todoList = document.getElementById('todo-list');
            if (!todoList) return;

            todoList.innerHTML = '';
            gameState.completedTasks = [];
            gameState.tasksCompletedToday = 0;
            gameState.isWorkingToday = false; // Reset work status for the new day

            // NEW: Determine if it's an off-day (e.g., 20% chance for non-YouTubers)
            gameState.isOffDay = (gameState.job !== 'youtuber' && Math.random() < 0.2); // 20% chance for an off day

            let availableTasks = [];

            // If it's an off day, add the "Enjoy Your Day Off" task and no work tasks
            if (gameState.isOffDay) {
                availableTasks.push(offDayTask);
                showFeedback(`It's your day off, ${gameState.playerName}! No work today. üéâ`);
            } else {
                // If not an off-day, get tasks relevant to the current job
                const currentJobTasks = jobSpecificTasks[gameState.job] || [];
                let workOrStudyTasks = currentJobTasks.filter(task => task.isWorkTask);
                let nonWorkTasks = currentJobTasks.filter(task => !task.isWorkTask);

                // Ensure at least one work/study task is available if it's a work day
                if (workOrStudyTasks.length > 0) {
                    const randomWorkTask = workOrStudyTasks[Math.floor(Math.random() * workOrStudyTasks.length)];
                    availableTasks.push(randomWorkTask);
                    // Add remaining non-work tasks
                    availableTasks = availableTasks.concat(nonWorkTasks);
                } else {
                    // If somehow no work tasks are defined for the job, just add non-work tasks
                    availableTasks = availableTasks.concat(nonWorkTasks);
                }
            }

            // Add common tasks that apply to the current job, filtering out work-related if it's an off day
            commonTasks.forEach(task => {
                if (task.appliesTo && task.appliesTo.includes(gameState.job)) {
                    // Skip if it's a work-related task and it's an off day
                    if (gameState.isOffDay && task.isWorkTask) {
                        return;
                    }
                    // Only add morning routine if not a YouTuber
                    if (task.id === 'morning-routine-common' && gameState.job === 'youtuber') {
                        return;
                    }
                    // Add pay rent if it's due
                    if (task.id === 'pay-rent') {
                        const rentBill = gameState.billsDue.find(bill => bill.id === 'rent');
                        if (rentBill && !rentBill.paid && gameState.day % rentBill.dueDate === 0) {
                            availableTasks.push(task);
                        }
                        return;
                    }
                    // Add utilities if due
                    if (task.id === 'pay-utilities') {
                        const utilitiesBill = gameState.billsDue.find(bill => bill.id === 'utilities');
                        if (utilitiesBill && !utilitiesBill.paid && gameState.day % utilitiesBill.dueDate === 0) {
                            availableTasks.push(task);
                        }
                        return;
                    }
                    // Add internet bill if due
                    if (task.id === 'pay-internet') {
                        const internetBill = gameState.billsDue.find(bill => bill.id === 'internet');
                        if (internetBill && !internetBill.paid && gameState.day % internetBill.dueDate === 0) {
                            availableTasks.push(task);
                        }
                        return;
                    }
                    // Add grocery shopping if it's not a YouTuber (YouTubers have special grocery task)
                    if (task.id === 'grocery-shopping' && gameState.job === 'youtuber') {
                        return;
                    }
                    availableTasks.push(task);
                }
            });

            // NEW: Add pet tasks if applicable
            if (gameState.petType !== 'none') {
                petTasks.forEach(task => {
                    if (task.requiresPet && task.appliesTo.includes(gameState.job)) { // Ensure pet tasks apply to current job
                        availableTasks.push(task);
                    }
                });
            }


            // Filter tasks based on numKids if applicable
            availableTasks = availableTasks.filter(task => {
                // If the job is YouTuber, no kid-related tasks should appear regardless of numKids setting
                if (gameState.job === 'youtuber') {
                    return !task.id.includes('feed-kids') && !task.id.includes('quality-time') && !task.id.includes('daycare');
                }
                // For other jobs, filter based on numKids
                if (task.requiresKids && gameState.numKids === 0) {
                    return false; // Exclude tasks that require kids if no kids
                }
                return true;
            });

            // Determine if daycare tasks should be added (if player has kids and there's work/study today)
            let addDaycareTasks = false;
            // Daycare tasks only if not an off-day and player has kids
            if (!gameState.isOffDay && gameState.numKids > 0 && gameState.job !== 'youtuber' && availableTasks.some(task => task.isWorkTask)) {
                addDaycareTasks = true;
            }

            // Add daycare drop-off if needed
            if (addDaycareTasks) {
                const daycareDropoffTask = jobSpecificTasks[gameState.job].find(t => t.id === 'daycare-dropoff');
                if (daycareDropoffTask) {
                    availableTasks.unshift(daycareDropoffTask); // Add to the beginning
                }
            }

            // Add generic filler tasks if needed to reach MIN_TASKS_PER_DAY
            const allGenericTasks = [...genericFillerTasks];
            while (availableTasks.length < MIN_TASKS_PER_DAY) {
                const randomGenericTask = allGenericTasks[Math.floor(Math.random() * allGenericTasks.length)];
                // Ensure we don't add duplicates of the same generic task if the pool is small
                if (!availableTasks.some(task => task.id === randomGenericTask.id)) {
                    availableTasks.push(randomGenericTask);
                } else {
                    // If all generic tasks are already added, break to prevent infinite loop
                    if (availableTasks.length >= allGenericTasks.length + currentJobTasks.length + commonTasks.length + petTasks.length) {
                        break;
                    }
                    // If we can't add a unique generic task, try another random one
                    continue;
                }
            }


            // Shuffle remaining tasks for variety
            availableTasks = availableTasks.sort(() => 0.5 - Math.random());

            // Limit tasks shown per day to exactly MIN_TASKS_PER_DAY
            const tasksForToday = availableTasks.slice(0, MIN_TASKS_PER_DAY);

            // Add daycare pick-up if drop-off was added
            if (addDaycareTasks) {
                const daycarePickupTask = jobSpecificTasks[gameState.job].find(t => t.id === 'daycare-pickup');
                if (daycarePickupTask) {
                    // Ensure it's not already in tasksForToday (e.g., if it was picked as a random task)
                    if (!tasksForToday.some(task => task.id === daycarePickupTask.id)) {
                        tasksForToday.push(daycarePickupTask); // Add to the end
                    }
                }
            }


            tasksForToday.forEach(task => {
                const taskDiv = document.createElement('div');
                taskDiv.className = 'todo-item';
                if (task.id.includes('work') || task.id.includes('shift') || task.id.includes('monetize') || task.id.includes('nurse') || task.id.includes('pay-rent') || task.id.includes('attend-lectures') || task.id.includes('study-for-class') || task.id.includes('send-job-applications') || task.id.includes('check-ircc-updates') || task.id.includes('part-time-shift-student') || task.id.includes('last-minute-shift') || task.id.includes('morning-huddle') || task.id.includes('patient-rounds') || task.id.includes('emergency-response') || task.id.includes('charting-documentation') || task.id.includes('team-collaboration') || task.id.includes('patient-education') || task.id.includes('roblox-gameplay') || task.id.includes('edit-roblox-video') || task.id.includes('upload-roblox-video') || task.id.includes('live-stream-roblox') || task.id.includes('research-roblox-trends') || task.id.includes('collaborate-roblox-youtuber') || task.id.includes('monetize-content-youtuber')) taskDiv.classList.add('work-task'); // Updated for Nurse and YouTuber work tasks
                else if (task.id.includes('feed') || task.id.includes('quality') || task.id.includes('routine') || task.id.includes('daycare')) taskDiv.classList.add('family-task'); // Added daycare here
                else if (task.id.includes('nap') || task.id.includes('study') || task.id.includes('explore') || task.id.includes('call-home') || task.id.includes('attend-lectures') || task.id.includes('brainstorm') || task.id.includes('research') || task.id.includes('walk') || task.id.includes('meditate') || task.id.includes('stretch') || task.id.includes('snack') || task.id.includes('journaling') || task.id.includes('yoga') || task.id.includes('creative')) taskDiv.classList.add('self-care-task'); // Added new self-care tasks
                else if (task.id.includes('grocery') || task.id.includes('house') || task.id.includes('tool') || task.id.includes('material') || task.id.includes('utilities') || task.id.includes('internet') || task.id.includes('organize') || task.id.includes('plan')) taskDiv.classList.add('chore-task'); // Added new chore tasks
                else if (task.id.includes('film') || task.id.includes('edit') || task.id.includes('upload') || task.id.includes('engage') || task.id.includes('live-stream') || task.id.includes('collaborate') || task.id.includes('social-event') || task.id.includes('deal-with-haters') || task.id.includes('call-friend') || task.id.includes('social-media') || task.id.includes('music') || task.id.includes('news') || task.id.includes('funny') || task.id.includes('dance')) taskDiv.classList.add('social-task'); // YouTuber/Student specific social/content tasks, and new social tasks
                else if (task.id.includes('pet')) taskDiv.classList.add('family-task'); // Pet tasks are family tasks
                else if (task.id === 'day-off') taskDiv.classList.add('self-care-task'); // NEW: Off day task type


                taskDiv.innerHTML = `
                    <div class="todo-text">${task.text}</div>
                    <div class="todo-details">Time: ${task.time}hr | Effects: ${formatEffects(task.effects)}</div>
                    <button class="btn task-btn" data-task-id="${task.id}" onclick="completeTask(this, 'main')">Do Task</button>
                `;
                todoList.appendChild(taskDiv);

                // NEW: Disable internet-dependent tasks if internet is down
                if (gameState.internetDown && task.requiresInternet) {
                    taskDiv.classList.add('internet-disabled');
                    taskDiv.querySelector('.task-btn').disabled = true;
                }
            });
        }

        // NEW: Generate and display whims
        function generateWhims() {
            const whimsList = document.getElementById('whims-list');
            const whimsSection = document.getElementById('whims-section');
            if (!whimsList || !whimsSection) return;

            whimsList.innerHTML = '';
            gameState.activeWhims = [];

            // Randomly decide how many whims (0 to 2)
            const numWhims = Math.floor(Math.random() * 3); // 0, 1, or 2

            if (numWhims === 0) {
                whimsSection.style.display = 'none';
                return;
            }

            whimsSection.style.display = 'block';
            const shuffledWhims = [...whims].sort(() => 0.5 - Math.random());

            for (let i = 0; i < numWhims; i++) {
                const whim = shuffledWhims[i];
                if (whim) {
                    gameState.activeWhims.push(whim);
                    const whimDiv = document.createElement('div');
                    whimDiv.className = 'todo-item whim-task';
                    whimDiv.innerHTML = `
                        <div class="todo-text">${whim.text}</div>
                        <div class="todo-details">Time: ${whim.time}hr | Effects: ${formatEffects(whim.effects)}</div>
                        <button class="btn task-btn" data-task-id="${whim.id}" onclick="completeTask(this, 'whim')">Do Whim</button>
                    `;
                    whimsList.appendChild(whimDiv);

                    // NEW: Disable internet-dependent whims if internet is down
                    if (gameState.internetDown && whim.requiresInternet) {
                        whimDiv.classList.add('internet-disabled');
                        whimDiv.querySelector('.task-btn').disabled = true;
                    }
                }
            }
        }


        function formatEffects(effects) {
            return Object.entries(effects).map(([key, value]) => {
                const sign = (typeof value === 'number' && value > 0) ? '+' : '';
                let label = key.replace(/([A-Z])/g, ' $1').toLowerCase();
                if (key === 'kidHappiness') label = 'kid happiness';
                if (key === 'subscribers') label = 'subscribers';
                if (key === 'socialLife') label = 'social life';
                if (key === 'petHappiness') label = 'pet happiness'; // NEW: Pet happiness label
                if (key === 'mood') return `Mood: ${value}`; // Special handling for mood
                return `${sign}${value} ${label}`;
            }).filter(effect => !effect.includes('mood:')).join(', '); // Filter out mood for display in details
        }

        function completeTask(button, type) {
            const taskId = button.dataset.taskId;
            let task;

            if (type === 'main') {
                task = [...jobSpecificTasks[gameState.job], ...commonTasks, ...petTasks, ...genericFillerTasks].find(t => t.id === taskId); // Include generic tasks
            } else if (type === 'whim') {
                task = gameState.activeWhims.find(w => w.id === taskId);
            }

            if (!task || button.disabled) return;

            showTaskAnimation(task);

            const difficultyMultiplier = getDifficultyMultiplier(); // Get current difficulty

            // Apply base effects
            for (const key in task.effects) {
                let effectValue = task.effects[key];

                if (key === 'mood') {
                    gameState.mood = effectValue; // Directly set mood
                    continue; // Skip numerical application for mood
                }

                if (key === 'stress' && effectValue === 'random') { // Handle random stress for social media / news
                    effectValue = Math.floor(Math.random() * (20 - 5 + 1)) + 5; // Random stress between 5 and 20
                }
                // Handle random class consequence for international student
                if (key === 'stress' && effectValue === 'randomClassConsequence') {
                    const consequenceType = Math.random() < 0.5 ? 'lockedOut' : 'humiliated';
                    if (consequenceType === 'lockedOut') {
                        effectValue = 40; // Higher stress
                        gameState.nextDayLectureConsequence = 'lockedOut';
                        showFeedback('You were locked out of class! Major stress hit!');
                    } else {
                        effectValue = 30; // Moderate stress
                        gameState.nextDayLectureConsequence = 'humiliated';
                        showFeedback('Your professor humiliated you for being late! Stress increased, mood hit!');
                    }
                }
                // Handle severe crisis for childcare cancellation
                if (key === 'stress' && effectValue === 'severeCrisis') {
                    effectValue = 50; // Very high stress
                    showStressBreakdownAnimation(); // Trigger the specific animation
                }


                // Apply mood modifiers to energy and stress changes
                if (key === 'energy' || key === 'stress') {
                    if (gameState.mood === 'Happy') {
                        effectValue = key === 'energy' ? effectValue * 1.2 : effectValue * 0.8; // More energy, less stress
                    } else if (gameState.mood === 'Stressed' || gameState.mood === 'Overwhelmed') {
                        effectValue = key === 'energy' ? effectValue * 0.8 : effectValue * 1.2; // Less energy, more stress
                    } else if (gameState.mood === 'Bored') {
                        effectValue = key === 'energy' ? effectValue * 0.9 : effectValue * 1.1; // Slightly less energy, more stress
                    }

                    // NEW: Apply difficulty multiplier to energy and stress costs
                    if (key === 'energy' && effectValue < 0) { // Only apply to negative energy effects (costs)
                        effectValue *= difficultyMultiplier;
                    } else if (key === 'stress' && effectValue > 0) { // Only apply to positive stress effects (gains)
                        effectValue *= difficultyMultiplier;
                    }
                }

                // Apply future shift penalty
                if (key === 'futureShiftPenalty' && effectValue === true) {
                    gameState.nextDayShiftPenalty = true;
                }

                // Apply job/class consequence for childcare cancellation
                if (key === 'jobConsequence' && effectValue === true) {
                    if (gameState.job === 'shop-assistant' || gameState.job === 'nurse') { // Updated for Nurse
                        gameState.money -= 100; // Penalty for missing work
                        showFeedback('You missed a day of work due to childcare. -$100!');
                    } else if (gameState.job === 'international-student') {
                        // For students, assume a missed class impacts future academic performance/stress
                        gameState.stress += 25;
                        showFeedback('You missed class due to childcare. Academic stress increased!');
                    }
                }

                // NEW: Handle internet outage flag
                if (key === 'internetDown' && effectValue === true) {
                    gameState.internetDown = true;
                    // Re-populate tasks to disable internet-dependent ones immediately
                    populateTasks();
                }


                if (gameState.hasOwnProperty(key)) {
                    gameState[key] += effectValue;
                } else if (key === 'subscribers' && gameState.job === 'youtuber') {
                    gameState.subscribers += effectValue;
                } else if (key === 'kidHappiness' && gameState.job !== 'youtuber') {
                    gameState.kidHappiness += effectValue;
                } else if (key === 'petHappiness' && gameState.petType !== 'none') { // NEW: Apply pet happiness
                    gameState.petHappiness += effectValue;
                }
            }
            gameState.time += task.time;
            gameState.tasksCompletedToday++;

            // NEW: Set isWorkingToday flag if a work task is completed
            if (task.isWorkTask) {
                gameState.isWorkingToday = true;
            }

            // Handle specific task consequences
            if (taskId === 'pay-rent') {
                const rentBill = gameState.billsDue.find(bill => bill.id === 'rent');
                if (rentBill) rentBill.paid = true;
            }
            // NEW: Mark utilities and internet bills as paid
            if (taskId === 'pay-utilities') {
                const utilitiesBill = gameState.billsDue.find(bill => bill.id === 'utilities');
                if (utilitiesBill) utilitiesBill.paid = true;
            }
            if (taskId === 'pay-internet') {
                const internetBill = gameState.billsDue.find(bill => bill.id === 'internet');
                if (internetBill) internetBill.paid = true;
            }

            if (taskId === 'buy-lottery-ticket') {
                triggerLotteryOutcome(); // Trigger lottery outcome immediately
            }
            // Trigger London Bus Dilemma after daycare drop-off
            if (task.triggerBusEvent && gameState.numKids > 0 && Math.random() < 0.3) { // 30% chance to miss bus
                triggerLondonBusDilemma();
            }
            // Trigger Toddler Meltdown after grocery shopping
            if (task.triggerTantrum && gameState.numKids > 0 && Math.random() < 0.3) { // 30% chance for tantrum
                showModal(toddlerMeltdownEvent.title, toddlerMeltdownEvent.description, toddlerMeltdownEvent.choices.map(choice => ({
                    text: choice.text,
                    action: () => handleEventChoice(choice)
                })));
            }


            button.disabled = true;
            button.closest('.todo-item').classList.add('completed');
            updateUI();

            // Random event trigger (excluding whims and specific triggers)
            // Also exclude if internet is down and it's an internet outage event
            // NEW: Only trigger random event if it's not an off day OR if the event doesn't require work
            if (type === 'main' && !task.triggerBusEvent && !task.triggerTantrum && !gameState.procrastinatusActive && Math.random() < 0.2) {
                const potentialEvent = randomEvents.filter(event => event.title !== 'Emergency Meeting! üåê Internet Outage!')[Math.floor(Math.random() * randomEvents.length)];
                if (potentialEvent && (potentialEvent.title !== 'Emergency Meeting! üåê Internet Outage!' || !gameState.internetDown)) { // Prevent double-triggering internet outage
                    // NEW: Check if event requires work and if it's an off day
                    if (!potentialEvent.requiresWork || gameState.isWorkingToday) {
                         triggerRandomEvent();
                    }
                }
            }
            // NEW: Trigger pet chaos if pet happiness is very low
            if (gameState.petType !== 'none' && gameState.petHappiness < 20 && Math.random() < 0.4) { // 40% chance if happiness is critical
                showModal(randomEvents.find(e => e.title === 'Emergency Meeting! üêæ Pet Chaos!').title,
                         randomEvents.find(e => e.title === 'Emergency Meeting! üêæ Pet Chaos!').description,
                         randomEvents.find(e => e.title === 'Emergency Meeting! üêæ Pet Chaos!').choices.map(choice => ({
                             text: choice.text,
                             action: () => handleEventChoice(choice)
                         })));
            }


            // Lord Procrastinatus trigger
            if (!gameState.procrastinatusActive && gameState.tasksCompletedToday < jobSpecificTasks[gameState.job].length && Math.random() < 0.15) { // Lower chance
                triggerLordProcrastinatus();
            }

            const allTasksCompleted = Array.from(document.querySelectorAll('.todo-item:not(.completed)')).length === 0;
            if (allTasksCompleted || gameState.time >= 22 || gameState.energy <= 0 || gameState.stress >= 100) { // End day if energy or stress hits 0/100
                endDay();
            }
        }

        // NEW: Lottery Outcome
        function triggerLotteryOutcome() {
            const outcomes = [
                { text: 'You won $10!', effects: { money: +10, stress: -2, mood: 'Happy' }, likelihood: 0.4 },
                { text: 'You won $50!', effects: { money: +50, stress: -5, mood: 'Happy' }, likelihood: 0.25 },
                { text: 'You won $200!', effects: { money: +200, stress: -10, mood: 'Happy' }, likelihood: 0.1 },
                { text: 'You won nothing. Better luck next time!', effects: { stress: +5, mood: 'Bored' }, likelihood: 0.25 }
            ];

            const rand = Math.random();
            let cumulativeLikelihood = 0;
            let chosenOutcome = outcomes[outcomes.length - 1]; // Default to no win

            for (const outcome of outcomes) {
                cumulativeLikelihood += outcome.likelihood;
                if (rand < cumulativeLikelihood) {
                    chosenOutcome = outcome;
                    break;
                }
            }

            // Apply effects of the chosen outcome
            for (const key in chosenOutcome.effects) {
                if (gameState.hasOwnProperty(key)) {
                    gameState[key] += chosenOutcome.effects[key];
                }
            }
            showFeedback(`Lottery Result: ${chosenOutcome.message}`);
            updateUI();
        }


        // ===============================================
        // TASK ANIMATION SYSTEM
        // ===============================================
        function showTaskAnimation(task) {
            const animationContainer = document.getElementById('task-animation-container');
            const animationScene = document.getElementById('task-animation-scene');

            if (!animationContainer || !animationScene) return;

            animationScene.innerHTML = '';
            animationScene.className = 'animation-scene';

            if (task.animation && task.animation.class) {
                animationScene.classList.add(task.animation.class);
            }

            animationScene.innerHTML = `
                <h3 class="animation-title">${task.text}</h3>
                <div class="animation-visual">${task.animation ? task.animation.emoji : '‚ú®'}</div>
                <p class="animation-description">${task.animation ? task.animation.description : 'Task in progress...'}</p>
                <button class="close-animation-btn" onclick="hideTaskAnimation()">Skip Animation</button>
            `;

            animationContainer.classList.add('active');

            setTimeout(() => {
                hideTaskAnimation();
                showFeedback(task.message);
            }, 2500);
        }

        // NEW: Specific animation for severe stress breakdown
        function showStressBreakdownAnimation() {
            const animationContainer = document.getElementById('task-animation-container');
            const animationScene = document.getElementById('task-animation-scene');

            if (!animationContainer || !animationScene) return;

            animationScene.innerHTML = '';
            animationScene.className = 'animation-scene stress-breakdown-anim'; // Apply specific class

            animationScene.innerHTML = `
                <h3 class="animation-title">Total Meltdown!</h3>
                <div class="animation-visual">üò≠</div>
                <p class="animation-description">The pressure is too much. You feel completely overwhelmed and break down.</p>
                <button class="close-animation-btn" onclick="hideTaskAnimation()">Acknowledge the Chaos</button>
            `;

            animationContainer.classList.add('active');

            // Keep it on screen a bit longer to convey severity
            setTimeout(() => {
                hideTaskAnimation();
            }, 4000); // 4 seconds
        }


        function hideTaskAnimation() {
            const animationContainer = document.getElementById('task-animation-container');
            if (animationContainer) {
                animationContainer.classList.remove('active');
            }
        }


        // ===============================================
        // RANDOM EVENT / EMERGENCY MEETING
        // ===============================================
        function showModal(title, description, choices, modalId = 'random-event-modal') { // NEW: Added modalId parameter
            const modal = document.getElementById(modalId);
            // Added null checks for elements inside the modal content
            const eventTitle = modal ? modal.querySelector('.modal-title') : null;
            const eventDescription = modal ? modal.querySelector('.modal-text') : null;
            const eventChoices = modal ? modal.querySelector('.modal-choices') : null; // This might be null for playability-modal

            if (!modal || !eventTitle || !eventDescription) {
                console.error(`Error: Modal element with ID '${modalId}' or its essential children not found.`);
                return; // Stop execution if essential elements are missing
            }

            eventTitle.textContent = title;
            eventDescription.textContent = description;

            if (eventChoices) { // Only clear and populate if choices exist (e.g., not for playability modal)
                eventChoices.innerHTML = '';
                choices.forEach(choice => {
                    const choiceBtn = document.createElement('button');
                    choiceBtn.className = 'btn choice-btn';
                    choiceBtn.textContent = choice.text;
                    choiceBtn.onclick = () => {
                        if (choice.action) choice.action();
                        else handleEventChoice(choice);
                        hideModal(modalId); // Pass the modalId to hide the correct modal
                    };
                    eventChoices.appendChild(choiceBtn);
                });
            }
            modal.classList.add('active');
        }

        function hideModal(modalId = 'random-event-modal') { // NEW: Added modalId parameter
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function triggerRandomEvent() {
            // Filter events by job and kid status and pet status
            const applicableEvents = randomEvents.filter(event => {
                const jobMatch = !event.job || event.job.includes(gameState.job); // Check if event.job array includes current job
                const kidsMatch = (event.hasKids === undefined) || (event.hasKids === (gameState.numKids > 0));
                const petMatch = (event.requiresPet === undefined) || (event.requiresPet === (gameState.petType !== 'none'));
                // NEW: Filter by isWorkingToday flag
                const workStatusMatch = (event.requiresWork === undefined) || (event.requiresWork === gameState.isWorkingToday);


                // Prevent Internet Outage event if internet is already down
                if (event.title === 'Emergency Meeting! üåê Internet Outage!' && gameState.internetDown) {
                    return false;
                }
                // Prevent Pet Chaos event if no pet or pet happiness is high
                if (event.title === 'Emergency Meeting! üêæ Pet Chaos!' && (gameState.petType === 'none' || gameState.petHappiness >= 20)) {
                    return false;
                }
                // Prevent Scam Call if already stressed or low on money to avoid immediate game over
                if (event.title === 'Emergency Meeting! üìû Scam Call!' && (gameState.stress > 80 || gameState.money < 50)) {
                    return false;
                }


                return jobMatch && kidsMatch && petMatch && workStatusMatch; // NEW: Include work status match
            });

            if (applicableEvents.length === 0) {
                console.log("No applicable random events for current state.");
                return;
            }

            const event = applicableEvents[Math.floor(Math.random() * applicableEvents.length)];
            showModal(event.title, event.description, event.choices.map(choice => ({
                text: choice.text,
                action: () => handleEventChoice(choice)
            })));
        }

        function handleEventChoice(choice) {
            for (const key in choice.effects) {
                let effectValue = choice.effects[key];
                if (key === 'mood') {
                    gameState.mood = effectValue;
                    continue;
                }
                // Handle severe crisis for childcare cancellation
                if (key === 'stress' && effectValue === 'severeCrisis') {
                    effectValue = 50; // Very high stress
                    showStressBreakdownAnimation(); // Trigger the specific animation
                }
                // Apply job/class consequence for childcare cancellation
                if (key === 'jobConsequence' && effectValue === true) {
                    if (gameState.job === 'shop-assistant' || gameState.job === 'nurse') { // Updated for Nurse
                        gameState.money -= 100; // Penalty for missing work
                        showFeedback('You missed a day of work due to childcare. -$100!');
                    } else if (gameState.job === 'international-student') {
                        // For students, assume a missed class impacts future academic performance/stress
                        gameState.stress += 25;
                        showFeedback('You missed class due to childcare. Academic stress increased!');
                    }
                }

                // NEW: Handle internet outage flag
                if (key === 'internetDown' && effectValue === true) {
                    gameState.internetDown = true;
                    // Re-populate tasks to disable internet-dependent ones immediately
                    populateTasks();
                }


                if (gameState.hasOwnProperty(key)) {
                    gameState[key] += effectValue;
                } else if (key === 'subscribers' && gameState.job === 'youtuber') {
                    gameState.subscribers += effectValue;
                } else if (key === 'kidHappiness' && gameState.job !== 'youtuber') {
                    gameState.kidHappiness += effectValue;
                } else if (key === 'petHappiness' && gameState.petType !== 'none') { // NEW: Apply pet happiness
                    gameState.petHappiness += effectValue;
                }
            }
            showFeedback(choice.message);
            updateUI();
        }

        // NEW: Function to trigger the London Bus Dilemma
        function triggerLondonBusDilemma() {
            // NEW: Only trigger if it's a work day
            if (!gameState.isWorkingToday) {
                console.log("Skipping bus dilemma: Not a work day.");
                return;
            }

            const jobChoices = londonBusDilemma.choices[gameState.job];
            if (!jobChoices) {
                console.warn("No bus dilemma choices for current job:", gameState.job);
                return;
            }

            showModal(londonBusDilemma.title, londonBusDilemma.description, jobChoices.map(choice => ({
                text: choice.text,
                action: () => handleLondonBusChoice(choice)
            })));
        }

        // NEW: Function to handle choices from the London Bus Dilemma
        function handleLondonBusChoice(choice) {
            for (const key in choice.effects) {
                let effectValue = choice.effects[key];
                if (key === 'mood') {
                    gameState.mood = effectValue;
                    continue;
                }
                if (key === 'randomClassConsequence') {
                    const consequenceType = Math.random() < 0.5 ? 'lockedOut' : 'humiliated';
                    if (consequenceType === 'lockedOut') {
                        gameState.stress += 40; // Higher stress
                        gameState.mood = 'Overwhelmed';
                        gameState.nextDayLectureConsequence = 'lockedOut';
                        showFeedback('You were locked out of class! Major stress hit!');
                    } else {
                        gameState.stress += 30; // Moderate stress
                        gameState.mood = 'Stressed';
                        gameState.nextDayLectureConsequence = 'humiliated';
                        showFeedback('Your professor humiliated you for being late! Stress increased, mood hit!');
                    }
                    continue; // Skip direct application if it's a random consequence
                }
                if (key === 'futureShiftPenalty' && effectValue === true) {
                    gameState.nextDayShiftPenalty = true;
                }

                if (gameState.hasOwnProperty(key)) {
                    gameState[key] += effectValue;
                }
            }
            showFeedback(choice.message);
            updateUI();
        }


        // ===============================================
        // DAILY DILEMMA
        // ===============================================
        function displayDailyDilemma() {
            const dilemmaDisplay = document.getElementById('daily-dilemma-display');
            if (!dilemmaDisplay) return;

            // Filter dilemmas by job and kid status
            const applicableDilemmas = dailyDilemmas.filter(dilemma => {
                const jobMatch = !dilemma.job || dilemma.job.includes(gameState.job);
                const kidsMatch = (dilemma.hasKids === undefined) || (dilemma.hasKids === (gameState.numKids > 0));
                // NEW: Filter by isWorkingToday flag
                const workStatusMatch = (dilemma.requiresWork === undefined) || (dilemma.requiresWork === gameState.isWorkingToday);

                return jobMatch && kidsMatch && workStatusMatch; // NEW: Include work status match
            });

            if (applicableDilemmas.length === 0) {
                dilemmaDisplay.textContent = `Day ${gameState.day}: A quiet day in London, ON. No major dilemmas... yet!`;
                dilemmaDisplay.style.display = 'block';
                return;
            }

            const randomDilemma = applicableDilemmas[Math.floor(Math.random() * applicableDilemmas.length)];
            dilemmaDisplay.textContent = `Day ${gameState.day}: ${randomDilemma.text.replace('{dayNum}', gameState.day)}`;
            dilemmaDisplay.style.display = 'block';
        }

        // ===============================================
        // LORD PROCRASTINATUS (INNER DEMON)
        // ===============================================
        function triggerLordProcrastinatus() {
            if (gameState.procrastinatusActive) return;

            const activeTaskButtons = Array.from(document.querySelectorAll('.todo-item:not(.completed) .task-btn'));
            if (activeTaskButtons.length === 0) return;

            const workTaskButtons = activeTaskButtons.filter(btn => btn.closest('.todo-item').classList.contains('work-task'));
            const targetButton = workTaskButtons.length > 0 ? workTaskButtons[Math.floor(Math.random() * workTaskButtons.length)] : activeTaskButtons[Math.floor(Math.random() * activeTaskButtons.length)];

            const targetTaskItem = targetButton.closest('.todo-item');
            const originalTaskText = targetTaskItem.querySelector('.todo-text').textContent;

            gameState.procrastinatusActive = true;
            targetButton.disabled = true;
            targetTaskItem.classList.add('sabotaged');

            const demonNotification = document.getElementById('demon-notification');
            if (demonNotification) {
                demonNotification.textContent = `üòà Lord Procrastinatus has cast a 'Delay Spell' on "${originalTaskText.trim()}"!`;
                demonNotification.style.display = 'block';
                demonNotification.style.animation = 'none';
                void demonNotification.offsetWidth;
                demonNotification.style.animation = 'fadeInOut 3s forwards';
            }

            setTimeout(() => {
                if (targetButton && targetTaskItem) {
                    targetButton.disabled = false;
                    targetTaskItem.classList.remove('sabotaged');
                }
                gameState.procrastinatusActive = false;
            }, 3000);
        }

        // ===============================================
        // END OF DAY & NEXT DAY LOGIC
        // ===============================================
        function endDay() {
            let endOfDayMessages = [];

            // 1. Penalty for incomplete tasks
            const incompleteTasks = Array.from(document.querySelectorAll('.todo-item:not(.completed):not(.whim-task)')).length; // Exclude whims from main penalty
            if (incompleteTasks > 0) {
                const stressIncrease = incompleteTasks * 10; // 10 stress per incomplete task
                gameState.stress += stressIncrease;
                endOfDayMessages.push(`You left ${incompleteTasks} main task(s) incomplete, increasing your stress by ${stressIncrease} points! üò•`);
            }

            // 2. Penalty for uncompleted whims
            const uncompletedWhims = gameState.activeWhims.filter(whim => {
                const whimElement = document.querySelector(`.todo-item.whim-task[data-task-id="${whim.id}"]`);
                // Ensure the element exists before checking its classList
                return whimElement && !whimElement.classList.contains('completed');
            }).length;

            if (uncompletedWhims > 0) {
                const stressIncrease = uncompletedWhims * 5; // Smaller stress for whims
                gameState.stress += stressIncrease;
                endOfDayMessages.push(`You missed ${uncompletedWhims} whim(s), adding ${stressIncrease} stress. Missed opportunities! üòî`);
            }

            // 3. Check for missed deadlines (Bills)
            gameState.billsDue.forEach(bill => {
                if (!bill.paid && gameState.day % bill.dueDate === 0) { // If due today and not paid
                    let penaltyMessage = `üö® You missed your ${bill.name} payment!`;
                    let stressPenalty = 0;
                    let moneyPenalty = 0;

                    if (bill.id === 'rent') {
                        stressPenalty = 50;
                        moneyPenalty = bill.amount * 0.1; // 10% late fee
                        penaltyMessage += ` Stress +${stressPenalty}, Late fee -$${moneyPenalty}. This is critical!`;
                    } else if (bill.id === 'utilities') {
                        stressPenalty = 30;
                        moneyPenalty = bill.amount * 0.05; // 5% late fee
                        penaltyMessage += ` Stress +${stressPenalty}, Late fee -$${moneyPenalty}. Your power might be cut!`;
                    } else if (bill.id === 'internet') {
                        stressPenalty = 25;
                        moneyPenalty = bill.amount * 0.05; // 5% late fee
                        penaltyMessage += ` Stress +${stressPenalty}, Late fee -$${moneyPenalty}. Your internet might be disconnected!`;
                        gameState.internetDown = true; // NEW: Internet goes down if bill missed
                    }

                    gameState.stress += stressPenalty;
                    gameState.money -= moneyPenalty;
                    gameState.missedDeadlines.push(penaltyMessage);
                    endOfDayMessages.push(penaltyMessage);
                }
            });


            // 4. Kid/Subscriber Repercussions
            if (gameState.job !== 'youtuber' && gameState.numKids > 0 && gameState.kidHappiness < 30) {
                gameState.stress += 20;
                endOfDayMessages.push(`üë∂ Your kids are very unhappy! Stress increased. Try to spend more quality time.`);
            }
            if (gameState.job === 'youtuber' && gameState.subscribers < 10) { // Very low subs
                gameState.stress += 30;
                endOfDayMessages.push(`‚ñ∂Ô∏è Your subscriber count is critically low! Stress increased. Focus on content quality and engagement.`);
            }
            // NEW: Pet Repercussions
            if (gameState.petType !== 'none' && gameState.petHappiness < 20) {
                gameState.stress += 20;
                endOfDayMessages.push(`üêæ Your pet is very unhappy! Stress increased. Make sure to feed and play with them.`);
            }

            // NEW: Penalty for not working on a work day
            if (!gameState.isOffDay && !gameState.isWorkingToday && gameState.job !== 'youtuber') { // YouTubers don't have a strict "work" task always
                const missedWorkPenalty = 40; // Example stress penalty for missing work
                gameState.stress += missedWorkPenalty;
                gameState.money -= 50; // Financial penalty
                endOfDayMessages.push(`üö´ You didn't complete any work tasks today! Stress +${missedWorkPenalty}, Money -$50. This will affect your career!`);
            }


            // Default message if no specific events
            if (endOfDayMessages.length === 0) {
                endOfDayMessages.push('You made it through another day! üåü');
            }

            // NEW: Record game end timestamp for cooldown
            localStorage.setItem('lastGameEnd', new Date().getTime().toString());
            saveGameState(); // Save game state at end of day


            updateEndOfDayReport(endOfDayMessages.join('<br><br>')); // Pass all messages to report
            showScreen('end-of-day-screen');
        }

        function nextDay() {
            gameState.day++;
            gameState.time = 7;
            gameState.energy = 100;
            gameState.stress = Math.max(0, gameState.stress - 20); // Reduce stress a bit
            gameState.socialLife = Math.min(100, Math.max(0, gameState.socialLife - 5)); // Social life decays slightly

            if (gameState.petType !== 'none') {
                gameState.petHappiness = Math.max(0, gameState.petHappiness - 10); // Pet happiness decays
            }

            if (gameState.job === 'youtuber') {
                gameState.subscribers = Math.max(0, gameState.subscribers + (Math.random() * 20 - 10)); // Small random change for subs
                gameState.milestoneAchieved = false; // Reset milestone flag for next potential milestone
            } else {
                gameState.kidHappiness = Math.max(50, gameState.kidHappiness - 10); // Kids might be slightly less happy from previous day's chaos
            }

            // Apply next-day penalties from bus event
            if (gameState.nextDayShiftPenalty) {
                gameState.money -= 50; // Example penalty for fewer shifts
                gameState.stress += 15;
                showFeedback('Your boss gave you fewer shifts today due to yesterday\'s lateness! -$50, Stress +15.');
                gameState.nextDayShiftPenalty = false; // Reset
            }
            if (gameState.nextDayLectureConsequence) {
                if (gameState.nextDayLectureConsequence === 'lockedOut') {
                    gameState.stress += 20;
                    showFeedback('Still feeling the sting of being locked out of class yesterday! Stress +20.');
                } else if (gameState.nextDayLectureConsequence === 'humiliated') {
                    gameState.stress += 15;
                    gameState.mood = 'Stressed';
                    showFeedback('The memory of yesterday\'s humiliation in class lingers! Stress +15, Mood: Stressed.');
                }
                gameState.nextDayLectureConsequence = null; // Reset
            }


            // Reset daily flags/counters
            gameState.tasksCompletedToday = 0;
            gameState.procrastinatusActive = false;
            gameState.activeWhims = []; // Clear whims for the new day
            gameState.missedDeadlines = []; // Clear missed deadlines for the new day
            gameState.internetDown = false; // NEW: Internet is back on for the new day
            gameState.isWorkingToday = false; // NEW: Reset work status for the new day
            gameState.isOffDay = false; // NEW: Reset off day status for the new day


            // Reset paid status for recurring bills for the new cycle (e.g., monthly)
            gameState.billsDue.forEach(bill => {
                if (gameState.day % bill.dueDate === 0) { // Simple monthly check, adjust as needed
                    bill.paid = false;
                }
            });


            populateTasks();
            displayDailyDilemma();
            generateWhims(); // Generate new whims for the day
            showScreen('daily-dashboard');
            updateUI();
            saveGameState(); // Save game state after advancing to next day
        }

        // ===============================================
        // MY CHAOTIC STORY DAILY REPORT
        // ===============================================
        function updateEndOfDayReport(summaryMessage) { // Accept summary message
            const reportGrid = document.getElementById('daily-report-grid');
            if (!reportGrid) return;

            reportGrid.innerHTML = '';

            let categories = [];

            // Common categories
            categories.push(
                {id: 'selfcare', label: 'Self-Care', icon: 'üßò‚Äç‚ôÄÔ∏è', value: gameState.energy, thresholdGood: 70, thresholdOkay: 40},
                {id: 'finances', label: 'Finances', icon: 'üí∞', value: gameState.money, thresholdGood: 400, thresholdOkay: 200},
                {id: 'social', label: 'Social Life', icon: 'ü§ù', value: gameState.socialLife, thresholdGood: 70, thresholdOkay: 40} // NEW: Social Life in report
            );

            // Job-specific categories
            if (gameState.job === 'youtuber') {
                categories.push(
                    {id: 'content', label: 'Content Creation', icon: 'üé•', value: gameState.tasksCompletedToday, thresholdGood: 3, thresholdOkay: 1}, // Based on tasks done
                    {id: 'subscribers', label: 'Subscribers', icon: 'üìà', value: gameState.subscribers, thresholdGood: 1000, thresholdOkay: 500} // Thresholds for 1000 and 500 subs
                );
            } else if (gameState.numKids > 0) { // For shop-assistant, international student, nurse with kids
                categories.push(
                    {id: 'family', label: 'Family/Kids', icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', value: gameState.kidHappiness, thresholdGood: 70, thresholdOkay: 40}
                );
            }

            if (gameState.petType !== 'none') { // NEW: Pet Happiness in report
                categories.push(
                    {id: 'pets', label: 'Pet Happiness', icon: gameState.petType === 'dog' ? 'üê∂' : 'üê±', value: gameState.petHappiness, thresholdGood: 70, thresholdOkay: 40}
                );
            }

            if (gameState.job === 'international-student') {
                categories.push(
                    {id: 'academics', label: 'Academics', icon: 'üéì', value: gameState.energy - gameState.stress, thresholdGood: 30, thresholdOkay: 0},
                    {id: 'integration', label: 'London Life', icon: 'üá®üá¶', value: gameState.tasksCompletedToday, thresholdGood: 2, thresholdOkay: 0}
                );
            } else if (gameState.job === 'nurse') { // Updated for Nurse
                categories.push(
                    {id: 'physical', label: 'Physical Health', icon: 'üí™', value: gameState.energy, thresholdGood: 60, thresholdOkay: 30},
                    {id: 'productivity', label: 'Productivity', icon: 'üè•', value: gameState.tasksCompletedToday, thresholdGood: 3, thresholdOkay: 1}
                );
            } else if (gameState.job === 'shop-assistant') {
                categories.push(
                    {id: 'work-perf', label: 'Work Performance', icon: 'üìä', value: gameState.tasksCompletedToday, thresholdGood: 3, thresholdOkay: 1}
                );
            }


            categories.forEach(cat => {
                let statusClass = 'status-critical';
                let statusText = '‚ùå Critical';

                if (cat.id === 'finances') {
                    if (cat.value >= cat.thresholdGood) {
                        statusClass = 'status-balanced';
                        statusText = `üìà Stable ($${cat.value})`; // Show actual money
                    } else if (cat.value >= cat.thresholdOkay) {
                        statusClass = 'status-strained';
                        statusText = `üìâ Tight ($${cat.value})`; // Show actual money
                    } else {
                        statusClass = 'status-critical';
                        statusText = `üí∏ Crisis ($${cat.value})`; // Show actual money
                    }
                } else if (cat.id === 'subscribers') {
                    // Subscriber specific thresholds
                    if (cat.value >= cat.thresholdGood) {
                        statusClass = 'status-balanced';
                        statusText = `üìà Trending (${Math.round(cat.value)} subs)`;
                    } else if (cat.value >= cat.thresholdOkay) {
                        statusClass = 'status-strained';
                        statusText = `‚ÜîÔ∏è Stable (${Math.round(cat.value)} subs)`;
                    } else {
                        statusClass = 'status-critical';
                        statusText = `üìâ Losing Ground (${Math.round(cat.value)} subs)`;
                    }
                } else if (cat.id === 'work-perf' || cat.id === 'content' || cat.id === 'productivity' || cat.id === 'integration' || cat.id === 'academics') {
                    if (cat.value >= cat.thresholdGood) {
                        statusClass = 'status-balanced';
                        statusText = '‚úÖ On Track';
                    } else if (cat.value >= cat.thresholdOkay) {
                        statusClass = 'status-strained';
                        statusText = '‚ö†Ô∏è Behind';
                    } else {
                        statusClass = 'status-critical';
                        statusText = '‚ùå Missed';
                    }
                }
                else { // For percentage-based resources like Energy, Happiness, Stress, Social Life, Pet Happiness
                    if (cat.value >= cat.thresholdGood) {
                        statusClass = 'status-balanced';
                        statusText = 'üòä Balanced';
                    } else if (cat.value >= cat.thresholdOkay) {
                        statusClass = 'status-strained';
                        statusText = 'üòî Strained';
                    } else {
                        statusClass = 'status-critical';
                        statusText = 'ü§Ø Critical';
                    }
                }


                const reportItem = document.createElement('div');
                reportItem.className = 'report-category';
                reportItem.innerHTML = `
                    <span class="icon">${cat.icon}</span>
                    <div class="label">${cat.label}</div>
                    <div class="status ${statusClass}">${statusText}</div>
                `;
                reportGrid.appendChild(reportItem);
            });

            const daySummaryElement = document.getElementById('day-summary');
            if (daySummaryElement) {
                daySummaryElement.innerHTML = summaryMessage; // Use innerHTML to render <br>
            }
        }
    </script>
</body>

</html>
